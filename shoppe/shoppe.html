<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shoppe — VVIP25</title>
  <meta name="theme-color" content="#0b0b0c" />
  <link rel="icon" href="/favicon.ico?v=3">
  <style>
    :root{--bg:#0b0b0c;--fg:#eceff4;--muted:#9aa0a6;--card:#141416;--border:#26272b;--accent:#6ee7b7;--logo:#fdf6d0}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,"Segoe UI",Roboto,Inter,system-ui,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    #site-title{margin:0;font-size:40px;font-weight:800;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;color:transparent;-webkit-text-fill-color:transparent;-webkit-text-stroke:2px var(--logo)}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn,.input,.sel{
      background:var(--card);color:var(--fg);border:1px solid var(--border);
      border-radius:10px;padding:8px 12px;text-decoration:none;line-height:1;appearance:none
    }
    .input{min-width:200px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin:16px 0 24px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:1/1;background:#1b1c20;position:relative}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{position:absolute;top:10px;left:10px;font-size:12px;border:1px solid var(--border);border-radius:999px;padding:4px 10px;background:rgba(0,0,0,.35);backdrop-filter:blur(4px)}
    .body{padding:12px}
    .title{font-weight:700}
    .desc{color:var(--muted);font-size:13px;margin-top:4px;min-height:2lh}
    .row{display:flex;align-items:center;justify-content:space-between;margin-top:10px;gap:10px}
    .price{font-weight:700}
    .buy{display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .buy svg{width:18px;height:18px;fill:var(--fg)}
    .muted{color:var(--muted)}
    footer{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:18px 0 8px}
    .link{color:var(--fg);text-decoration:none;border:1px solid var(--border);padding:8px 12px;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 id="site-title">VVIP25</h1>
      <div class="toolbar">
        <input id="q" class="input" placeholder="Search… try #tee, poster, cassette" />
        <select id="sort" class="sel" title="Sort">
          <option value="new">Newest</option>
          <option value="price_asc">Price ↑</option>
          <option value="price_desc">Price ↓</option>
          <option value="title_asc">Title A–Z</option>
        </select>
        <a href="/" class="btn" title="Back to player">⟵ Player</a>
      </div>
    </header>

    <div id="status" class="muted" style="margin-top:8px;"></div>
    <div id="grid" class="grid" aria-live="polite"></div>

    <footer>
      <a class="link" href="https://virtualvip.bandcamp.com/" target="_blank" rel="noopener">Bandcamp</a>
      <a class="link" href="https://www.instagram.com/virtualvip24/" target="_blank" rel="noopener">Instagram</a>
      <a class="link" href="https://www.youtube.com/@VVVVIIPP25" target="_blank" rel="noopener">YouTube</a>
      <a class="link" href="https://substack.com/home/post/p-170664918?source=queue" target="_blank" rel="noopener">Newsletter</a>
    </footer>
  </div>

  <script>
(function(){
  const ASSET_VERSION = 2; // bump when you update shoppe.json
  const $ = s => document.querySelector(s);
  const grid = $('#grid');
  const q = $('#q');
  const sortSel = $('#sort');
  const status = $('#status');
  let items = [], filtered = [];

  init();

  async function init(){
    status.textContent = 'Loading shop…';
    try{
      const data = await loadShoppeJSON();
      items = Array.isArray(data) ? data : [];
      filtered = items.slice();
      applySort(); render();
      status.textContent = `${filtered.length} item${filtered.length===1?'':'s'}`;
    }catch(err){
      console.error(err);
      status.innerHTML = 'Could not load <code>shoppe.json</code>.';
      grid.innerHTML = '';
    }
  }

  // --- loader with root-absolute URL + fallback and diagnostics
  async function loadShoppeJSON(){
    const candidates = [
      `/shoppe.json?v=${ASSET_VERSION}`,        // root (correct for your setup)
      `/shoppe/shoppe.json?v=${ASSET_VERSION}`, // fallback if you later move it into /shoppe/
    ];
    let lastErr;
    for (const url of candidates){
      try{
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
        const json = await res.json();
        // quick sanity
        if (!Array.isArray(json)) throw new Error('JSON parsed but not an array');
        return json;
      }catch(e){
        lastErr = e;
        showDiag(`Fetch failed: <code>${url}</code><br><small>${e.message||e}</small>`);
      }
    }
    throw lastErr || new Error('All shoppe.json URLs failed');
  }

  function showDiag(html){
    let d = document.getElementById('shoppe-diag');
    if(!d){
      d = document.createElement('div');
      d.id = 'shoppe-diag';
      d.style.cssText = 'position:fixed;left:12px;right:12px;bottom:12px;z-index:9999;background:#1b1c20;color:#f2f2f2;border:1px solid #333;padding:10px;border-radius:8px;font:13px/1.4 system-ui,-apple-system';
      document.body.appendChild(d);
    }
    d.innerHTML = `⚠️ <b>Shoppe</b> — ${html}`;
  }

  function render(){
    if(!filtered.length){ grid.innerHTML = ''; return; }
    grid.innerHTML = filtered.map(cardHTML).join('');
  }

  function cardHTML(p){
    const price = (p.price!=null) ? `${p.currency||'USD'} ${Number(p.price).toFixed(2)}` : '';
    const badge = p.available ? '' : `<span class="badge">Out of stock</span>`;
    const buyDisabled = p.available ? '' : 'aria-disabled="true" tabindex="-1"';
    const buyHref = p.available ? `href="${escapeHTML(p.url||'#')}" target="_blank" rel="noopener"` : '';
    return `
      <article class="card">
        <div class="thumb">
          <img src="${escapeHTML(p.image||'')}" alt="">
          ${badge}
        </div>
        <div class="body">
          <div class="title">${escapeHTML(p.title||'Item')}</div>
          <div class="desc">${escapeHTML(p.description||'')}</div>
          <div class="row">
            <div class="price">${price}</div>
            <a class="btn buy" ${buyHref} ${buyDisabled} title="Buy">
              ${bagIcon()} <span>Buy</span>
            </a>
          </div>
        </div>
      </article>`;
  }

  function bagIcon(){
    return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 7h12l-1 13H7L6 7zm3-2a3 3 0 0 1 6 0v2h-2V5a1 1 0 1 0-2 0v2H9V5z"/></svg>`;
  }

  function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  function applySort(){
    switch(sortSel.value){
      case 'price_asc': filtered.sort((a,b)=>(a.price??1e9)-(b.price??1e9)); break;
      case 'price_desc': filtered.sort((a,b)=>(b.price??0)-(a.price??0)); break;
      case 'title_asc': filtered.sort((a,b)=>String(a.title||'').localeCompare(String(b.title||''))); break;
      default: break; // "new": keep file order
    }
  }

  function applySearch(){
    const query = (q.value||'').toLowerCase().trim();
    if(!query){ filtered = items.slice(); applySort(); render(); status.textContent = `${filtered.length} item${filtered.length===1?'':'s'}`; return; }
    const toks = query.split(/\s+/).filter(Boolean);
    filtered = items.filter(p=>{
      const hayTitle = String(p.title||'').toLowerCase();
      const hayDesc  = String(p.description||'').toLowerCase();
      const hayTags  = (p.tags||[]).map(t=>String(t).toLowerCase());
      return toks.every(tk=>{
        if(tk.startsWith('#')) return hayTags.includes(tk); // tag must match (e.g. "#tee")
        return hayTitle.includes(tk) || hayDesc.includes(tk) || hayTags.some(t=>t.includes(tk));
      });
    });
    applySort(); render();
    status.textContent = `${filtered.length} match${filtered.length===1?'':'es'}`;
  }

  q.addEventListener('input', applySearch);
  sortSel.addEventListener('change', ()=>{ applySort(); render(); });

})();
</script>
</body>
</html>