<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VVIP25</title>
  <link rel="icon" type="image/png" sizes="64x64" href="/favicon-64.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" href="/favicon.ico?v=3">
  <meta name="theme-color" content="#0b0b0c"/>
  <style>
    :root{--bg:#0b0b0c;--fg:#eceff4;--muted:#9aa0a6;--card:#141416;--border:#26272b;--accent:#6ee7b7}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,"Segoe UI",Roboto,Inter,system-ui,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:16px}

    html{-webkit-text-size-adjust:100%}
    input,select,button{font-size:16px}
    @media (max-width:560px){
      body{font-size:15px}
      header{gap:8px}
      #site-title{font-size:44px;-webkit-text-stroke:1.5px #fdf6d0}
      .wrap{padding:12px}
      .row{grid-template-columns:auto 1fr auto;padding:8px 10px;min-height:64px}
      .badge .pill{padding:3px 8px;font-size:11px}
    }

    header{display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative}
    #site-title{margin:0;font-size:56px;font-weight:bold;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;color:transparent;-webkit-text-fill-color:transparent;-webkit-text-stroke:2px #fdf6d0}

    .player{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,11,12,.97),rgba(11,11,12,.92));backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--border)}
    .now{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:12px 0}
    .cover{width:56px;height:56px;border-radius:8px;background:#1e1f24;display:grid;place-items:center;color:var(--muted);font-weight:700;border:1px solid var(--border)}
    .meta{min-width:0}
    .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .controls{display:flex;align-items:center;gap:8px}
    button{appearance:none;background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .range{display:flex;align-items:center;gap:8px}
    input[type="range"]{width:160px}
    .list{margin:12px 0 40px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .row{display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center;padding:10px 12px;border-top:1px solid var(--border);background:var(--card);min-height:78px}
    .row:first-child{border-top:0}
    .row:hover{background:#17171b}
    .badge{display:flex;gap:10px;align-items:center;font-size:12px;justify-self:end}
    .badge a{color:var(--fg);text-decoration:none;border:1px solid var(--border);padding:4px 8px;border-radius:8px}
    .badge .muted{color:var(--muted)}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .tog,.btn{display:inline-flex;align-items:center;justify-content:center;height:36px;min-width:36px;padding:0 10px;border-radius:10px;border:1px solid var(--border);background:var(--card);text-decoration:none;color:var(--fg);line-height:1}
    .tog{opacity:.6;transition:opacity .15s, box-shadow .15s}
    .tog.on{opacity:1;box-shadow:0 0 0 2px var(--accent) inset}
    details.menu>summary{cursor:pointer;list-style:none;background:var(--card);border:1px solid var(--border);padding:8px 12px;border-radius:10px;user-select:none}
    .sheet{position:absolute;top:calc(100% + 8px);right:0;z-index:20;width:min(420px,calc(100vw - 32px));background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;display:none;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    details.menu[open]>.sheet{display:block}
    details.menu[open]>summary{border-bottom-left-radius:10px;border-bottom-right-radius:10px}

    @supports (-webkit-touch-callout:none){.range[title="Volume"]{display:none !important}}

    @media (max-width:560px){
      .now{grid-template-columns:1fr;gap:8px}
      .cover{display:none}
      .controls{flex-wrap:wrap}
      .range input[type="range"]{width:120px}
      .row{grid-template-columns:1fr auto}
    }
  </style>
</head>
<body>
  <div class="player">
    <div class="wrap">
      <header>
        <h1 id="site-title">VVIP25</h1>
        <details class="menu" id="menu">
          <summary>‚ò∞ Menu</summary>
          <div class="sheet">
            <div class="toolbar" id="toolbar"></div>
          </div>
        </details>
      </header>

      <div class="now">
        <div class="cover" id="cover">V25</div>
        <div class="meta">
          <div class="title" id="now-title">‚Äî</div>
          <div class="sub" id="now-sub">Ready</div>
        </div>
        <div class="controls">
          <button id="prev" aria-label="Previous">‚èÆÔ∏è</button>
          <button id="toggle" aria-label="Play/Pause">‚ñ∂Ô∏è</button>
          <button id="next" aria-label="Next">‚è≠Ô∏è</button>
          <div class="range">
            <span id="tcur">0:00</span>
            <input id="seek" type="range" min="0" max="100" value="0" step="1" aria-label="Seek" />
            <span id="tdur">0:00</span>
          </div>
          <div class="range" title="Volume">
            <span>üîä</span>
            <input id="vol" type="range" min="0" max="1" step="0.01" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <main id="page-root" data-page="home">
    <div class="wrap">
      <div id="list" class="list" role="list"></div>
    </div>
  </main>

  <audio id="audio" preload="metadata"></audio>

<script>
/* ========= VVIPMEDIA ‚Äî Core Player (robust manifest parsing) ========= */
/* Works with your existing manifest entries exactly as-is. */

const ASSET_VERSION = 21;   // bump cache buster
const PREFERRED_TITLE = 'gone jotti';

/* ---------- Config (same-origin paths) ---------- */
const BASE_MP3   = '/ACCESS/';
const BASE_WAV   = '/WAV/';
const BASE_THUMB = '/ACCESS/';
const DEFAULT_THUMB = BASE_THUMB + 'default_thumb.jpg';

/* ---------- Tiny utilities ---------- */
const $=s=>document.querySelector(s);
function fmtDur(sec){ sec=Number(sec||0); const m=Math.floor(sec/60), s=Math.floor(sec%60); return `${m}:${String(s).padStart(2,'0')}`; }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
const rawFile=s=>(String(s).split('/').pop()||'');
const stripExt=s=>String(s).replace(/\.[a-z0-9]+$/i,'');
function bpmLabel(t){ if(t.bpm!=null) return `${t.bpm} BPM`; if(t.bpm_min!=null&&t.bpm_max!=null) return `${t.bpm_min}‚Äì${t.bpm_max} BPM`; return ''; }

/* ---------- Elements & State ---------- */
const els = {
  audio:$('#audio'), list:$('#list'),
  toggle:$('#toggle'), prev:$('#prev'), next:$('#next'),
  seek:$('#seek'), vol:$('#vol'),
  nowTitle:$('#now-title'), nowSub:$('#now-sub'), cover:$('#cover'),
  tcur:$('#tcur'), tdur:$('#tdur')
};
const state = {
  tracks:[], filtered:[], i:-1, playing:false,
  showTitles:true, showWavButtons:false, showMovButtons:false,
  favorites:new Set(JSON.parse(localStorage.getItem('vvip25:favs')||'[]')),
  searchQuery:'', favoritesOnly:false
};
els.vol.value = localStorage.getItem('vvip25:vol') ?? '0.9';
els.audio.volume = parseFloat(els.vol.value);

/* ---------- Boot ---------- */
init().catch(err=>renderError(err));

async function init(){
  const data = await loadManifest();              // robust
  state.tracks = normalizeTracks(data);           // safe map
  if (!state.tracks.length){ renderEmpty('No tracks found in manifest.'); return; }

  applyFilterSort();
  renderList();
  if (state.filtered.length) select(0);

  wireEvents();
}

/* ---------- Robust manifest loader ---------- */
async function loadManifest(){
  // try /manifest.json then ./manifest.json
  const urls = [`/manifest.json?v=${ASSET_VERSION}`, `./manifest.json?v=${ASSET_VERSION}`];
  let txt=null, lastErr=null;
  for (const u of urls){
    try {
      const res = await fetch(u, {cache:'no-store'});
      if (!res.ok) { lastErr = new Error(`HTTP ${res.status} for ${u}`); continue; }
      txt = await res.text();
      break;
    } catch(e){ lastErr=e; }
  }
  if (txt==null) throw lastErr || new Error('Could not fetch manifest.json');

  // normalize text (strip BOM/whitespace)
  txt = txt.replace(/^\uFEFF/,'').trim();

  // First parse
  let parsed;
  try { parsed = JSON.parse(txt); }
  catch(e){ throw new Error('manifest.json is not valid JSON'); }

  // If server wrapped the array in quotes, we get a string => parse again
  if (typeof parsed === 'string'){
    try { parsed = JSON.parse(parsed); }
    catch(e){ throw new Error('manifest.json contains a JSON string that is not a valid array'); }
  }

  if (!Array.isArray(parsed)) throw new Error('manifest.json must be a JSON array');
  return parsed;
}

/* ---------- Normalize entries ---------- */
function normalizeTracks(arr){
  return arr.map((t,idx)=>{
    const name = t?.name || t?.file || (t?.src? rawFile(t.src):`track-${idx}.mp3`);
    const base = stripExt(name);
    const date = t?.date ? new Date(t.date) : null;
    const src  = t?.src || (BASE_MP3 + encodeURIComponent(name));
    const title = t?.title || name;  // fallback to name if no title (prevents accidental hiding)
    const videos = [];
    if (typeof t?.video === 'string' && t.video.trim()) videos.push({label:'MOV', url:t.video.trim()});
    if (Array.isArray(t?.videos)) for (const v of t.videos){ if (v?.url) videos.push({label:v.label||'MOV', url:String(v.url)}); }
    return {
      id:idx, name, base, title,
      bpm:t?.bpm??null, bpm_min:t?.bpm_min??null, bpm_max:t?.bpm_max??null,
      details:t?.details||'', length:t?.length||0, date,
      src, wav: BASE_WAV + encodeURIComponent(base + '.wav'),
      videos, thumb: DEFAULT_THUMB
    };
  });
}

/* ---------- Filtering / sorting ---------- */
function applyFilterSort(){
  let out = [...state.tracks];

  // Sort newest first by date (fallback to name)
  out.sort((a,b)=>{
    const da=a.date? a.date.getTime():0, db=b.date? b.date.getTime():0;
    if (db!==da) return db-da;
    return String(b.name).localeCompare(String(a.name));
  });

  // IMPORTANT: do NOT hide "nameless" if titles fail ‚Äî safer default.
  // (If you want the previous behavior back later, we can add a toggle.)

  // Search (supports #tags in details)
  const q = (state.searchQuery||'').trim().toLowerCase();
  if (q){
    const toks = q.split(/\s+/).filter(Boolean);
    out = out.filter(t=>{
      const hay = (t.name+' '+t.title+' '+t.details).toLowerCase();
      return toks.every(tok => tok.startsWith('#') ? (t.details||'').toLowerCase().includes(tok) : hay.includes(tok));
    });
  }

  // Favorites view
  if (state.favoritesOnly) out = out.filter(t=>state.favorites.has(t.name));

  state.filtered = out;
}

/* ---------- Render ---------- */
function rowHTML(t, active){
  const sub = [bpmLabel(t), t.length?fmtDur(t.length):'', t.date? t.date.toISOString().slice(0,10):''].filter(Boolean).join(' ¬∑ ');
  const mov = (t.videos&&t.videos.length) ? t.videos.map(v=>`<a class="pill" href="${v.url}" target="_blank" rel="noopener">${escapeHTML(v.label||'MOV')}</a>`).join('') : '';
  return `<div class="row" role="listitem" data-id="${t.id}">
    <div class="cover"><img src="${t.thumb}" alt="" style="width:56px;height:56px;border-radius:8px;object-fit:cover"></div>
    <div>
      <div class="title">${active?'‚ñ∂Ô∏é ':''}${escapeHTML(state.showTitles ? (t.title||t.name) : t.name)}</div>
      <div class="sub">${escapeHTML(sub)}</div>
    </div>
    <div class="badge">
      <button class="star ${state.favorites.has(t.name)?'on':''}" data-fav="${escapeHTML(t.name)}" title="${state.favorites.has(t.name)?'Remove from favorites':'Add to favorites'}">‚òÖ</button>
      <a class="pill" href="${t.src}" download>MP3</a>
      ${state.showWavButtons? `<a class="pill" href="${t.wav}" download>WAV</a>`:''}
      ${state.showMovButtons? mov:''}
    </div>
  </div>`;
}
function renderList(){
  if (!state.filtered.length){ renderEmpty('No results.'); return; }
  els.list.innerHTML = state.filtered.map((t,i)=>rowHTML(t,i===state.i)).join('');
}
function renderEmpty(msg){
  els.list.innerHTML = `<div class="row"><div></div><div>${escapeHTML(msg)}</div></div>`;
}
function renderError(err){
  console.error(err);
  renderEmpty('Player error: '+ String(err && err.message || err));
}

/* ---------- Selection / Player ---------- */
function select(i){
  state.i = i;
  const t = state.filtered[i]; if(!t) return;
  els.audio.src = t.src;
  updateNowbar();
  state.playing = false; updateToggle();
  // refresh list row indicators
  els.list.querySelectorAll('.row .title').forEach((el,idx)=>{
    const tt = state.filtered[idx];
    el.innerHTML = (idx===i ? '‚ñ∂Ô∏é ' : '') + escapeHTML(state.showTitles ? (tt.title||tt.name) : tt.name);
  });
}
function updateNowbar(){
  const t=state.filtered[state.i]; if(!t) return;
  els.nowTitle.textContent = state.showTitles ? (t.title||t.name) : t.name;
  els.nowSub.textContent = [bpmLabel(t), t.length?fmtDur(t.length):'', t.date? t.date.toISOString().slice(0,10):''].filter(Boolean).join(' ¬∑ ');
  els.cover.innerHTML = `<img src="${t.thumb}" alt="" style="width:56px;height:56px;object-fit:cover;border-radius:8px">`;
}
async function play(){ try{ await els.audio.play(); state.playing=true; updateToggle(); }catch{} }
function pause(){ els.audio.pause(); state.playing=false; updateToggle(); }
function updateToggle(){ $('#toggle')?.setAttribute('data-state', state.playing ? 'pause' : 'play'); }
function jump(d){ if(!state.filtered.length) return; let i=state.i+d; if(i<0) i=state.filtered.length-1; if(i>=state.filtered.length) i=0; select(i); play(); }

/* ---------- Events ---------- */
function wireEvents(){
  document.addEventListener('click',(e)=>{
    const favBtn=e.target.closest?.('.star');
    if (favBtn && favBtn.hasAttribute('data-fav')){
      const key=favBtn.getAttribute('data-fav');
      const was=state.favorites.has(key);
      if (was) state.favorites.delete(key); else state.favorites.add(key);
      localStorage.setItem('vvip25:favs', JSON.stringify([...state.favorites]));
      favBtn.classList.toggle('on', !was);
      if (state.favoritesOnly) { applyFilterSort(); renderList(); }
      e.preventDefault(); return;
    }
    const row=e.target.closest?.('.row');
    if (row && !e.target.closest('a')){
      const id=Number(row.getAttribute('data-id'));
      const idx = state.filtered.findIndex(t=>t.id===id);
      if (idx>=0){ select(idx); play(); }
    }
  }, { passive:false });

  $('#toggle')?.addEventListener('click', ()=>{ if (state.i<0 && state.filtered.length) select(0); state.playing?pause():play(); });
  $('#prev')?.addEventListener('click', ()=> jump(-1));
  $('#next')?.addEventListener('click', ()=> jump(1));

  els.audio.addEventListener('timeupdate', ()=>{ const a=els.audio; if(!isFinite(a.duration)) return;
    els.seek.max=Math.floor(a.duration); els.seek.value=Math.floor(a.currentTime);
    $('#tcur').textContent=fmtDur(a.currentTime); $('#tdur').textContent=fmtDur(a.duration);
  });
  els.seek.addEventListener('input', ()=>{ els.audio.currentTime=Number(els.seek.value); });
  els.vol.addEventListener('input', ()=>{ els.audio.volume=parseFloat(els.vol.value||'0.9'); localStorage.setItem('vvip25:vol', els.vol.value); });
  els.audio.addEventListener('ended', ()=> jump(1));
}
</script>
</body>
</html>