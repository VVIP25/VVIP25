<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VVIP25</title>
<link rel="icon" type="image/png" sizes="64x64" href="/favicon-64.png">
<link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <meta name="theme-color" content="#0b0b0c" />
<style>
  :root{--bg:#0b0b0c;--fg:#eceff4;--muted:#9aa0a6;--card:#141416;--border:#26272b;--accent:#6ee7b7}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 -apple-system, BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,"Segoe UI",Roboto,Inter,system-ui,sans-serif}
  .wrap{max-width:920px;margin:0 auto;padding:16px}

  /* Header anchors the overlay panel */
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    position:relative;
  }

  /* Outline-only VVIP25 title, doubled size */
  #site-title{
    margin:0;
    font-size:56px;
    font-weight:bold;
    font-family:"Helvetica Neue", Helvetica, Arial, sans-serif;
    color:transparent;
    -webkit-text-fill-color:transparent; /* Safari */
    -webkit-text-stroke:2px #fdf6d0;     /* outline color + thickness */
  }

  .player{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,11,12,.97),rgba(11,11,12,.92));backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--border)}
  .now{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:12px 0}
  .cover{width:56px;height:56px;border-radius:8px;background:#1e1f24;display:grid;place-items:center;color:var(--muted);font-weight:700;border:1px solid var(--border)}
  .meta{min-width:0}
  .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sub{color:var(--muted);font-size:12px}
  .controls{display:flex;align-items:center;gap:8px}
  button{appearance:none;background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  .range{display:flex;align-items:center;gap:8px}
  input[type="range"]{width:160px}
  .list{margin:12px 0 40px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .row{display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center;padding:10px 12px;border-top:1px solid var(--border);background:var(--card)}
  .row:first-child{border-top:0}
  .row:hover{background:#17171b}
  .badge{display:flex;gap:10px;align-items:center;font-size:12px;justify-self:end}
  .badge a{color:var(--fg);text-decoration:none;border:1px solid var(--border);padding:4px 8px;border-radius:8px}
  .badge .muted{color:var(--muted)}
  .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas;background:#1b1c20;border:1px solid #2a2b30;border-radius:6px;padding:2px 6px;color:#d7dae0}

  /* Hamburger (overlay) */
  details.menu{position:static}
  details.menu > summary{
    cursor:pointer;list-style:none;background:var(--card);
    border:1px solid var(--border);padding:8px 12px;border-radius:10px;user-select:none;
  }

  /* The dropdown panel overlays below the header */
  .sheet{
    position:absolute;top:calc(100% + 8px);right:0;z-index:20;
    width:min(420px, calc(100vw - 32px));
    background:var(--card);border:1px solid var(--border);border-radius:10px;
    padding:10px;display:none;box-shadow:0 10px 24px rgba(0,0,0,.35);
  }
  details.menu[open] > .sheet{display:block}
  details.menu[open] > summary{border-bottom-left-radius:10px;border-bottom-right-radius:10px}

  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="search"],select,label.toggle{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 10px}

  /* Hide the volume control on iOS Safari (WebKit on iOS), all sizes */
  @supports (-webkit-touch-callout: none) {
    .range[title="Volume"]{display:none !important}
  }

  @media (max-width:560px){
    .now{grid-template-columns:1fr;gap:8px}
    .cover{display:none}
    .controls{flex-wrap:wrap}
    .range input[type="range"]{width:120px}
    .row{grid-template-columns:1fr auto}
  }
</style></head>
<body>
  <div class="player">
    <div class="wrap">
      <header>
        <h1 id="site-title">VVIP25</h1>
        <details class="menu">
          <summary>‚ò∞ Menu</summary>
          <div class="sheet">
            <div class="toolbar">
              <input id="q" type="search" placeholder="Search (filename, title, details)‚Ä¶" autocomplete="off" />
              <select id="sort" title="Sort">
                <option value="date_desc">Newest</option>
                <option value="date_asc">Oldest</option>
                <option value="name_asc">Name A‚ÜíZ</option>
                <option value="name_desc">Name Z‚ÜíA</option>
                <option value="bpm_desc">BPM ‚Üì</option>
                <option value="bpm_asc">BPM ‚Üë</option>
                <option value="details_asc">Details A‚ÜíZ</option>
                <option value="details_desc">Details Z‚ÜíA</option>
                <option value="len_desc">Longest</option>
                <option value="len_asc">Shortest</option>
              </select>
              <label class="toggle"><input id="nameMode" type="checkbox" /> Show given names</label>
            </div>
          </div>
        </details>
      </header>

      <div class="now">
        <div class="cover" id="cover">V25</div>
        <div class="meta">
          <div class="title" id="now-title">‚Äî</div>
          <div class="sub" id="now-sub">Ready</div>
        </div>
        <div class="controls">
          <button id="prev" aria-label="Previous">‚èÆÔ∏è</button>
          <button id="toggle" aria-label="Play/Pause">‚ñ∂Ô∏è</button>
          <button id="next" aria-label="Next">‚è≠Ô∏è</button>
          <div class="range">
            <span id="tcur">0:00</span>
            <input id="seek" type="range" min="0" max="100" value="0" step="1" aria-label="Seek" />
            <span id="tdur">0:00</span>
          </div>
          <div class="range" title="Volume">
            <span>üîä</span>
            <input id="vol" type="range" min="0" max="1" step="0.01" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
  <div id="list" class="list" role="list"></div>
</div>

<audio id="audio" preload="metadata"></audio>

<script>
  // ====== CONFIG ======
  const BASE_MP3    = 'https://media.vvipmedia.net/ACCESS/';  // MP3s
  const BASE_WAV    = 'https://media.vvipmedia.net/WAV/';     // WAVs
  const BASE_THUMB  = 'https://media.vvipmedia.net/ACCESS/';  // thumbs + default
  const BASE_VIDEO  = 'https://media.vvipmedia.net/VIDEOS/';  // MOVs
  const DEFAULT_THUMB = BASE_THUMB + 'default_thumb.jpg';

  // -------- Helpers --------
  const $ = sel => document.querySelector(sel);
  function fmtDur(sec){ sec=Number(sec||0); const m=Math.floor(sec/60), s=Math.floor(sec%60); return `${m}:${String(s).padStart(2,'0')}`; }
  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[c])); }

  function bpmSortValue(t){ if(t.bpm!=null) return t.bpm; if(t.bpm_min!=null&&t.bpm_max!=null) return (t.bpm_min+t.bpm_max)/2; return 0; }
  function bpmLabel(t){ if(t.bpm!=null) return `${t.bpm} BPM`; if(t.bpm_min!=null&&t.bpm_max!=null) return `${t.bpm_min}‚Äì${t.bpm_max} BPM`; return ''; }

  function removeBpm(str){
    if (!str) return str;
    return String(str)
      .replace(/\b\d+(?:\.\d+)?(?:\s*[‚Äì‚Äî-]\s*\d+(?:\.\d+)?)?\s*BPM\b/gi, '')
      .replace(/\s{2,}/g,' ')
      .trim();
  }
  function cleanToken(s){
    if (!s) return '';
    s = String(s).trim();
    s = s.replace(/^[¬∑‚Ä¢,;:\-]+|[¬∑‚Ä¢,;:\-]+$/g, '');
    s = s.replace(/\s*[.,;:]\s*$/,'');
    return s.trim();
  }
  function uniqJoin(parts){
    const seen = new Set(), out = [];
    for (let raw of parts){
      if (raw == null) continue;
      raw = cleanToken(removeBpm(raw));
      if (!raw) continue;
      const key = raw.toLowerCase();
      if (seen.has(key)) continue;
      seen.add(key);
      out.push(raw);
    }
    return out.join(' ¬∑ ');
  }

  // -------- Filename/date parsing --------
  const DATE_RX = /^\s*(\d{2})[.\-_](\d{2})[.\-_](\d{2})(?=\D|$)/;
  const WITHIN_DAY_RX = /^\s*\d{2}[.\-_]\d{2}[.\-_]\d{2}(?:-(\d+))?/;
  function fallbackDateFromName(name){
    const m = String(name).match(DATE_RX);
    if (!m) return null;
    const yy = parseInt(m[1], 10);
    const mm = Math.max(1, Math.min(12, parseInt(m[2], 10)));
    const dd = Math.max(1, Math.min(31, parseInt(m[3], 10)));
    return new Date(Date.UTC(2000 + yy, mm - 1, dd));
  }
  function withinDayIndexFromName(name){
    const m = String(name).match(WITHIN_DAY_RX);
    return m && m[1] ? parseInt(m[1], 10) : 0;
  }

  // -------- Els --------
  const els = {
    audio: $('#audio'),
    list: $('#list'),
    q: $('#q'),
    sort: $('#sort'),
    toggle: $('#toggle'),
    prev: $('#prev'),
    next: $('#next'),
    seek: $('#seek'),
    vol: $('#vol'),
    nowTitle: $('#now-title'),
    nowSub: $('#now-sub'),
    tcur: $('#tcur'),
    tdur: $('#tdur'),
    nameMode: $('#nameMode'),
    cover: $('#cover')
  };

  // -------- State --------
  const state = {
    tracks: [],
    filtered: [],
    i: -1,
    playing: false,
    pageSize: 60,
    renderCount: 0,
    titles: {},
    thumbBases: new Set(),   // bases that *have* a custom thumb (from thumbs.json)
    resolvedThumb: new Map() // track.id -> resolved thumb URL after cascade
  };

  // Persisted volume
  els.vol.value = localStorage.getItem('vvip25:vol') ?? '0.9';
  els.audio.volume = parseFloat(els.vol.value);

  // Boot
  init();
  async function init(){
    // 1) Manifest
    const mres = await fetch('./manifest.json');
    if(!mres.ok){
      els.list.innerHTML = `<div class="row"><div></div><div>manifest.json missing</div></div>`;
      return;
    }
    const data = await mres.json();

    // 2) Tracks (fast, no network checks)
    state.tracks = data.map((t,idx)=>{
      const name = t.name;
      const base = name.replace(/\.[^.]+$/,'');
      const baseLower = base.toLowerCase();
      const dateObj = t.date ? new Date(t.date) : fallbackDateFromName(name);
      const label = (t.title && t.title.trim()) || (t.date ? `${t.date}` : (dateObj ? dateObj.toISOString().slice(0,10) : name));

      // safer URL building for files that can include spaces, parens, etc.
      const mp3 = t.src || (BASE_MP3 + encodeURIComponent(name));
      const wav = BASE_WAV + encodeURIComponent(base + '.wav');     // ALWAYS show WAV (server expects original case)
      const mov = t.has_mov ? (BASE_VIDEO + encodeURIComponent(base + '.mov')) : null;

      // thumbs are stored lowercase on CDN
      const thumbCandidate = BASE_THUMB + encodeURIComponent(baseLower + 'thumb.jpg');

      return {
        id: idx,
        name,
        base,
        baseLower,
        title: t.title || '',
        bpm: t.bpm ?? null,
        bpm_min: t.bpm_min ?? null,
        bpm_max: t.bpm_max ?? null,
        details: t.details || '',
        length: t.length || 0,
        date: dateObj || null,
        label,
        src: mp3,
        wav,
        video: mov,
        thumbCandidate
      };
    });

    // 3) First paint ASAP; use default thumbs until cascade is computed
    applyFilterSort(true);
    computeThumbCascade();  // default-only cascade (uses DEFAULT_THUMB)
    renderList();           // refresh rows with resolved thumbs
    fillViewport();         // ensure we load enough rows to reach/trigger sentinel

    // 4) Lazy fetch titles + thumbs map
    (requestIdleCallback?.(fetchTitles, {timeout: 1200}) || setTimeout(fetchTitles, 0));
    (requestIdleCallback?.(fetchThumbs, {timeout: 1500}) || setTimeout(fetchThumbs, 50));
  }

  async function fetchTitles(){
    try{
      const tres = await fetch('./titles.json');
      if (!tres.ok) return;
      state.titles = await tres.json();
      let changed = false;
      for (const t of state.tracks){
        const newTitle = state.titles[t.name];
        if (typeof newTitle === 'string' && newTitle !== t.title){
          t.title = newTitle;
          const dateISO = t.date ? t.date.toISOString().slice(0,10) : '';
          t.label = t.title || (t.date ? `${dateISO}` : t.name);
          changed = true;
        }
      }
      if (changed) applyFilterSort(false, /*keepIndex=*/true);
    }catch(_){} // silent
  }

  // thumbs.json can be EITHER:
  //  - ["24.03.15.105","24.09.19.106", ...]  (bases that have thumbs)
  //  - {"24.03.15.105": true, ...}
  async function fetchThumbs(){
    try{
      const r = await fetch('./thumbs.json', { cache: 'no-store' });
      if (!r.ok) return; // absent is fine -> all default

      const data = await r.json();
      const set = new Set();
      if (Array.isArray(data)) {
        data.forEach(base => set.add(String(base).toLowerCase()));
      } else if (data && typeof data === 'object') {
        Object.keys(data).forEach(base => { if (data[base]) set.add(base.toLowerCase()); });
      }
      state.thumbBases = set;

      computeThumbCascade();       // recompute with real breaks
      rerenderVisibleRowsThumbs(); // refresh visible rows
      if (state.i>=0) updateNowbar();
    }catch(_){ /* ignore */ }
  }

  // Compute cascade once (global chronology), independent of current sort/filter.
  function computeThumbCascade(){
    // Sort ALL tracks by date ascending, then within-day index, then name
    const asc = [...state.tracks].sort((a,b)=>{
      const da = a.date?.getTime()||0, db = b.date?.getTime()||0;
      if (da!==db) return da-db;
      return withinDayIndexFromName(a.name)-withinDayIndexFromName(b.name) || a.name.localeCompare(b.name);
    });

    let currentThumb = DEFAULT_THUMB;
    for (const t of asc){
      if (state.thumbBases.has(t.baseLower)) currentThumb = t.thumbCandidate;
      state.resolvedThumb.set(t.id, currentThumb);
    }
  }

  function getResolvedThumb(t){
    return state.resolvedThumb.get(t.id) || DEFAULT_THUMB;
  }

  function applyFilterSort(firstPaint=false, keepIndex=false){
    const q = (els.q?.value||'').trim().toLowerCase();
    let out = state.tracks.filter(t=>{
      return !q || t.name.toLowerCase().includes(q) ||
             (t.title && t.title.toLowerCase().includes(q)) ||
             (t.details && t.details.toLowerCase().includes(q)) ||
             (t.label && t.label.toLowerCase().includes(q));
    });

    switch(els.sort?.value||'date_desc'){
      case 'date_desc':
        out.sort((a,b)=>{
          const da = a.date?.getTime()||0, db = b.date?.getTime()||0;
          if (db !== da) return db - da;
          return withinDayIndexFromName(b.name) - withinDayIndexFromName(a.name)
                 || b.name.localeCompare(a.name);
        });
        break;
      case 'date_asc':
        out.sort((a,b)=>{
          const da = a.date?.getTime()||0, db = b.date?.getTime()||0;
          if (da !== db) return da - db;
          return withinDayIndexFromName(a.name) - withinDayIndexFromName(b.name)
                 || a.name.localeCompare(b.name);
        });
        break;
      case 'name_asc':  out.sort((a,b)=> displayName(a).localeCompare(displayName(b))); break;
      case 'name_desc': out.sort((a,b)=> displayName(b).localeCompare(displayName(a))); break;
      case 'bpm_desc':  out.sort((a,b)=> bpmSortValue(b) - bpmSortValue(a)); break;
      case 'bpm_asc':   out.sort((a,b)=> bpmSortValue(a) - bpmSortValue(b)); break;
      case 'details_asc': out.sort((a,b)=> (a.details||'').localeCompare(b.details||'')); break;
      case 'details_desc': out.sort((a,b)=> (b.details||'').localeCompare(a.details||'')); break;
      case 'len_desc':  out.sort((a,b)=> (b.length||0)-(a.length||0)); break;
      case 'len_asc':   out.sort((a,b)=> (a.length||0)-(b.length||0)); break;
    }

    state.filtered = out;

    const initialChunk = firstPaint ? Math.max(60, state.pageSize) : state.pageSize;
    state.renderCount = Math.min(state.filtered.length, initialChunk);

    if (!keepIndex) state.i = Math.min(state.i, state.renderCount-1);
    renderList();
    setupInfiniteScroll();
    // safety: if sentinel not yet reachable, keep appending until we can scroll
    fillViewport();
  }

  function displayName(t){ return (els.nameMode?.checked && t.title) ? t.title : t.name; }

  // --- Safe <img> (no error loops) ---
  function imgHTML(src){
    const esc = s => s.replace(/"/g,'&quot;');
    // onerror handler swaps to default once, then disables itself
    return `<img src="${esc(src)}" alt="" loading="lazy"
      style="width:56px;height:56px;border-radius:8px;object-fit:cover;"
      onerror="if(this.dataset.fbk!=='1'){this.dataset.fbk='1';this.onerror=null;this.src='${DEFAULT_THUMB}';}">`;
  }

  function rowHTML(t, active){
    const mp3 = t.src, wav = t.wav, vid = t.video;
    const bpmTxt = bpmLabel(t);
    const thumbURL = getResolvedThumb(t);
    const subline = uniqJoin([ t.label, t.length ? fmtDur(t.length) : '', bpmTxt, t.details ]);

    return `<div class="row" role="listitem" data-id="${t.id}">
      <div class="cover" aria-hidden="true">
        ${imgHTML(thumbURL)}
      </div>
      <div>
        <div class="title">${active ? '‚ñ∂Ô∏é ' : ''}${escapeHTML(displayName(t))}</div>
        <div class="sub">${escapeHTML(subline)}</div>
      </div>
      <div class="badge">
        <a href="${mp3}" download title="Download MP3">‚¨áÔ∏é MP3</a>
        <a href="${BASE_WAV + encodeURIComponent(t.base + '.wav')}" download title="Download Lossless">‚¨áÔ∏é WAV</a>
        ${vid ? `<a href="${vid}" target="_blank" rel="noopener" title="Open Video">‚ñ∂Ô∏é MOV</a>` : '<span class="muted">MOV</span>'}
      </div>
    </div>`;
  }

  function renderList(){
    if(!state.filtered.length){
      els.list.innerHTML = '<div class="row"><div></div><div>No results.</div></div>';
      return;
    }
    const slice = state.filtered.slice(0, state.renderCount);
    els.list.innerHTML = slice.map(t=>{
      const active = (state.i>=0 && state.filtered[state.i]?.id===t.id);
      return rowHTML(t, active);
    }).join('') + `<div id="sentinel" style="height:1px"></div>`;
  }

  function rerenderVisibleRowsThumbs(){
    const rows = els.list.querySelectorAll('.row');
    rows.forEach(row=>{
      const id = Number(row.getAttribute('data-id'));
      const t = state.tracks.find(x=>x.id===id);
      if (!t) return;
      const img = row.querySelector('.cover img');
      if (img) { img.src = getResolvedThumb(t); } // keep onerror intact
    });
  }

  // --- Infinite scroll with robust fallbacks ---
  let sentinelObserver;
  function setupInfiniteScroll(){
    const sentinel = $('#sentinel');
    if (!sentinel) return;

    if (sentinelObserver) sentinelObserver.disconnect();
    if ('IntersectionObserver' in window){
      sentinelObserver = new IntersectionObserver((entries)=>{
        for (const e of entries){
          if (e.isIntersecting) appendChunk();
        }
      }, { root: null, rootMargin: '1200px 0px', threshold: 0 });
      sentinelObserver.observe(sentinel);
    }

    // Scroll fallback (covers browsers/pages where IO doesn't fire reliably)
    window.addEventListener('scroll', onScrollMaybeLoad, { passive: true });
    window.addEventListener('resize', debounce(fillViewport, 120), { passive: true });
  }

  function appendChunk(){
    if (state.renderCount >= state.filtered.length) return;
    const prev = state.renderCount;
    state.renderCount = Math.min(state.filtered.length, state.renderCount + state.pageSize);
    const sentinel = $('#sentinel');
    if (!sentinel) return;

    const frag = document.createDocumentFragment();
    for (let i=prev;i<state.renderCount;i++){
      const t = state.filtered[i];
      const div = document.createElement('div');
      div.innerHTML = rowHTML(t, (state.i>=0 && state.filtered[state.i]?.id===t.id));
      frag.appendChild(div.firstChild);
    }
    els.list.insertBefore(frag, sentinel);
  }

  function atBottomBuffer(px=1200){
    return (window.scrollY + window.innerHeight + px) >= document.documentElement.scrollHeight;
  }

  function onScrollMaybeLoad(){
    if (atBottomBuffer()) {
      appendChunk();
    }
  }

  // Ensure we can reach the sentinel / have enough rows to scroll
  function fillViewport(){
    let guard = 0;
    while (guard++ < 10) { // cap to avoid runaway
      const scrollable = document.documentElement.scrollHeight > window.innerHeight + 200;
      if (scrollable || state.renderCount >= state.filtered.length) break;
      appendChunk();
    }
  }

  function select(indexInFiltered){
    state.i = indexInFiltered;
    const t = state.filtered[indexInFiltered];
    if(!t) return;
    els.audio.src = t.src;
    updateNowbar();
    state.playing = false;
    updateToggle();
    // update active markers in rendered window
    const rendered = els.list.querySelectorAll('.row');
    rendered.forEach(row=>{
      const id = Number(row.getAttribute('data-id'));
      const isActive = (state.filtered[state.i]?.id === id);
      const titleEl = row.querySelector('.title');
      if (titleEl){
        const plain = escapeHTML(displayName(state.tracks.find(x=>x.id===id) || t));
        titleEl.innerHTML = (isActive ? '‚ñ∂Ô∏é ' : '') + plain;
      }
    });
  }

  function updateNowbar(){
    const t = state.filtered[state.i]; if(!t) return;
    els.nowTitle.textContent = displayName(t);
    els.nowSub.textContent = t.label || '';
    const url = getResolvedThumb(t);
    // safe image (no error loop)
    els.cover.innerHTML = `<img src="${url.replace(/"/g,'&quot;')}" alt=""
      style="width:56px;height:56px;border-radius:8px;object-fit:cover;"
      onerror="if(this.dataset.fbk!=='1'){this.dataset.fbk='1';this.onerror=null;this.src='${DEFAULT_THUMB}';}">`;
  }

  async function play(){
    try{
      await els.audio.play();
      state.playing = true; updateToggle();
      if('mediaSession' in navigator){
        const t = state.filtered[state.i];
        navigator.mediaSession.metadata = new MediaMetadata({ title: displayName(t) });
        navigator.mediaSession.setActionHandler('previoustrack', ()=> jump(-1));
        navigator.mediaSession.setActionHandler('nexttrack', ()=> jump(1));
        navigator.mediaSession.setActionHandler('seekbackward', ()=> els.audio.currentTime = Math.max(0, els.audio.currentTime-10));
        navigator.mediaSession.setActionHandler('seekforward', ()=> els.audio.currentTime = Math.min(els.audio.duration||0, els.audio.currentTime+10));
      }
    }catch(_){} 
  }
  function pause(){ els.audio.pause(); state.playing=false; updateToggle(); }
  function updateToggle(){ els.toggle.textContent = state.playing ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'; }
  function jump(dir){
    if(!state.filtered.length) return;
    let i = state.i + dir;
    if(i < 0) i = state.filtered.length-1;
    if(i >= state.filtered.length) i = 0;
    select(i); play();
  }

  // Events
  document.addEventListener('click', (e)=>{
    const row = e.target.closest('.row');
    if(row && e.target.closest('a')==null){
      const id = Number(row.getAttribute('data-id'));
      const idx = state.filtered.findIndex(t=>t.id===id);
      if(idx>=0){ select(idx); play(); }
    }
  }, { passive: true });

  els.q?.addEventListener('input', debounce(()=> applyFilterSort(), 80), { passive: true });
  els.sort?.addEventListener('change', ()=> applyFilterSort(), { passive: true });
  els.toggle.addEventListener('click', () => {
    if (state.i < 0 && state.filtered.length) select(0);
    state.playing ? pause() : play();
  }, { passive: true });
  els.prev.addEventListener('click', ()=> jump(-1), { passive: true });
  els.next.addEventListener('click', ()=> jump(1), { passive: true });

  els.audio.addEventListener('timeupdate', ()=>{
    const a=els.audio; if(!isFinite(a.duration)) return;
    els.seek.max = Math.floor(a.duration);
    els.seek.value = Math.floor(a.currentTime);
    els.tcur.textContent = fmtDur(a.currentTime);
    els.tdur.textContent = isFinite(a.duration) ? fmtDur(a.duration) : '0:00';
  });
  els.seek.addEventListener('input', ()=>{ els.audio.currentTime = Number(els.seek.value); });
  els.vol.addEventListener('input', ()=>{ els.audio.volume = parseFloat(els.vol.value); localStorage.setItem('vvip25:vol', els.vol.value); });
  els.audio.addEventListener('ended', ()=> jump(1));
  els.nameMode?.addEventListener('change', ()=>{
    const rendered = els.list.querySelectorAll('.row');
    rendered.forEach(row=>{
      const id = Number(row.getAttribute('data-id'));
      const t = state.tracks.find(x=>x.id===id);
      if (!t) return;
      const titleEl = row.querySelector('.title');
      if (titleEl){
        const activeMark = (state.i>=0 && state.filtered[state.i]?.id===id) ? '‚ñ∂Ô∏é ' : '';
        titleEl.innerHTML = activeMark + escapeHTML(displayName(t));
      }
    });
    if(state.i>=0) updateNowbar();
  });
</script>
</body>
</html>
