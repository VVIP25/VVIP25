<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VVIP25</title>
  <link rel="icon" type="image/png" sizes="64x64" href="/favicon-64.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" href="/favicon.ico?v=3">
  <meta name="theme-color" content="#0b0b0c" />
  <style>
    :root{--bg:#0b0b0c;--fg:#eceff4;--muted:#9aa0a6;--card:#141416;--border:#26272b;--accent:#6ee7b7}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,"Segoe UI",Roboto,Inter,system-ui,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:16px}

    header{display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative}
    #site-title{margin:0;font-size:56px;font-weight:bold;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;color:transparent;-webkit-text-fill-color:transparent;-webkit-text-stroke:2px #fdf6d0}

    .player{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,11,12,.97),rgba(11,11,12,.92));backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--border)}
    .now{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:12px 0}
    .cover{width:56px;height:56px;border-radius:8px;background:#1e1f24;display:grid;place-items:center;color:var(--muted);font-weight:700;border:1px solid var(--border)}
    .meta{min-width:0}
    .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .controls{display:flex;align-items:center;gap:8px}
    button{appearance:none;background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .range{display:flex;align-items:center;gap:8px}
    input[type="range"]{width:160px}
    .list{margin:12px 0 40px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .row{display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center;padding:10px 12px;border-top:1px solid var(--border);background:var(--card);min-height:78px}
    .row:first-child{border-top:0}
    .row:hover{background:#17171b}
    .badge{display:flex;gap:10px;align-items:center;font-size:12px;justify-self:end}
    .badge a{color:var(--fg);text-decoration:none;border:1px solid var(--border);padding:4px 8px;border-radius:8px}
    .badge .muted{color:var(--muted)}
    .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas;background:#1b1c20;border:1px solid #2a2b30;border-radius:6px;padding:2px 6px;color:#d7dae0}

    /* Toolbar + toggles */
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .tog,.btn{
      display:inline-flex;align-items:center;justify-content:center;
      height:36px;min-width:36px;padding:0 10px;
      border-radius:10px;border:1px solid var(--border);background:var(--card);
      text-decoration:none;color:var(--fg);line-height:1
    }
    .tog{opacity:.6;transition:opacity .15s, box-shadow .15s}
    .tog.on{opacity:1;box-shadow:0 0 0 2px var(--accent) inset}

    /* Hamburger (overlay) */
    details.menu{position:static}
    details.menu>summary{cursor:pointer;list-style:none;background:var(--card);border:1px solid var(--border);padding:8px 12px;border-radius:10px;user-select:none}
    .sheet{position:absolute;top:calc(100% + 8px);right:0;z-index:20;width:min(420px,calc(100vw - 32px));background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;display:none;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    details.menu[open]>.sheet{display:block}
    details.menu[open]>summary{border-bottom-left-radius:10px;border-bottom-right-radius:10px}

    /* Hide the volume control on iOS Safari */
    @supports (-webkit-touch-callout:none){.range[title="Volume"]{display:none !important}}

    @media (max-width:560px){
      .now{grid-template-columns:1fr;gap:8px}
      .cover{display:none}
      .controls{flex-wrap:wrap}
      .range input[type="range"]{width:120px}
      .row{grid-template-columns:1fr auto}
    }
  </style>
</head>
<body>
  <div class="player">
    <div class="wrap">
      <header>
        <h1 id="site-title">VVIP25</h1>
        <details class="menu" id="menu">
          <summary>☰ Menu</summary>
          <div class="sheet">
            <div class="toolbar" id="toolbar">
              <select id="sort" title="Sort">
                <option value="date_desc">Newest</option>
                <option value="date_asc">Oldest</option>
                <option value="bpm_desc">BPM ↓</option>
                <option value="bpm_asc">BPM ↑</option>
                <option value="len_desc">Longest</option>
                <option value="len_asc">Shortest</option>
              </select>
              <button class="tog on" id="togTitles" title="Song Titles (on/off)">📝</button>
              <button class="tog" id="togWav" title="Show WAV buttons">🎚️</button>
              <button class="tog" id="togMov" title="Show MOV buttons">🎬</button>
              <button class="btn" id="btnAbout" title="About">ℹ️</button>
              <a class="btn" id="btnShop" href="/shop" target="_blank" rel="noopener" title="Shop">🛍️</a>
            </div>
          </div>
        </details>
      </header>

      <div class="now">
        <div class="cover" id="cover">V25</div>
        <div class="meta">
          <div class="title" id="now-title">—</div>
          <div class="sub" id="now-sub">Ready</div>
        </div>
        <div class="controls">
          <button id="prev" aria-label="Previous">⏮️</button>
          <button id="toggle" aria-label="Play/Pause">▶️</button>
          <button id="next" aria-label="Next">⏭️</button>
          <div class="range">
            <span id="tcur">0:00</span>
            <input id="seek" type="range" min="0" max="100" value="0" step="1" aria-label="Seek" />
            <span id="tdur">0:00</span>
          </div>
          <div class="range" title="Volume">
            <span>🔊</span>
            <input id="vol" type="range" min="0" max="1" step="0.01" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="list" class="list" role="list"></div>
  </div>

  <audio id="audio" preload="metadata"></audio>

<script>
/* ========= VVIP25 — Phase 5 (icons + limited downloads + stability) ========= */

  const ASSET_VERSION = 13; // bump to beat caches on JSON fetches

  /* ---------- Config ---------- */
  const BASE_MP3   = 'https://media.vvipmedia.net/ACCESS/';
  const BASE_WAV   = 'https://media.vvipmedia.net/WAV/';
  const BASE_THUMB = 'https://media.vvipmedia.net/ACCESS/';
  const BASE_VIDEO = 'https://media.vvipmedia.net/VIDEOS/';
  const DEFAULT_THUMB = BASE_THUMB + 'default_thumb.jpg';

  /* ---------- Small cache hint ---------- */
  (function injectNoStoreMeta(){
    try{
      const m=document.createElement('meta');
      m.httpEquiv='Cache-Control';
      m.content='no-store, max-age=0, must-revalidate';
      document.head.appendChild(m);
    }catch(_){}
  })();

  /* ---------- CSS patches (footer download bar + subtle tweaks) ---------- */
  (function injectCSS(){
    const css = `
    .btn,.tog{
      display:inline-flex;align-items:center;justify-content:center;
      height:36px;min-width:36px;padding:0 12px;border-radius:10px;border:1px solid var(--border);
      background:var(--card);color:var(--fg);text-decoration:none;line-height:1;cursor:pointer
    }
    .tog{opacity:.75;transition:opacity .15s, box-shadow .15s}
    .tog.on{opacity:1;box-shadow:0 0 0 2px var(--accent) inset}

    .util-panel,.links-panel{display:none;margin-top:8px;border:1px solid var(--border);border-radius:10px;padding:8px}
    .util-row,.links-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    .search-wrap{display:none;gap:8px;align-items:center;margin-top:8px}
    .search-wrap input{flex:1;min-width:140px;background:var(--card);color:var(--fg);
      border:1px solid var(--border);border-radius:10px;padding:8px 10px}

    .pill{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;text-decoration:none;color:var(--fg)}
    .star{cursor:pointer}
    .star.on{filter:drop-shadow(0 0 2px var(--accent)) brightness(1.2)}

    /* Footer download bar */
    #dlbar{display:flex;justify-content:flex-end;margin:12px 0 40px}
    #dlbar .btn{gap:8px}
    #dlbar small{opacity:.7}

    /* Light mode minimal support (if you already had it) */
    body.light{--bg:#f7f7f8;--fg:#111;--muted:#4b5563;--card:#ffffff;--border:#d1d5db;--accent:#2563eb}
    body.light .player{background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.92))}
    body.light #site-title{-webkit-text-stroke:2px #111}
    `;
    const style=document.createElement('style');
    style.textContent=css;
    document.head.appendChild(style);
  })();

  /* ---------- Helpers ---------- */
  const $=sel=>document.querySelector(sel);
  function fmtDur(sec){ sec=Number(sec||0); const m=Math.floor(sec/60), s=Math.floor(sec%60); return `${m}:${String(s).padStart(2,'0')}`; }
  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  const rawFile=s=>(String(s).split('/').pop()||'');
  const stripExt=s=>String(s).replace(/\.[a-z0-9]+$/i,'');
  const softNorm=s=>stripExt(s).toLowerCase().replace(/[ _]+/g,'-').replace(/-+/g,'-');
  function deriveTitleFromFilename(name){ const b=stripExt(rawFile(name)).replace(/^[\d._-]+/,'').replace(/[_-]+/g,' ').trim(); return b || stripExt(rawFile(name)); }
  const primaryOnly = t => String(t||'').split('//')[0].trim();

  const DATE_RX_YYYY=/^\s*(\d{4})[.\-_](\d{2})[.\-_](\d{2})(?=\D|$)/;
  const DATE_RX_YY=/^\s*(\d{2})[.\-_](\d{2})[.\-_](\d{2})(?=\D|$)/;
  const WITHIN_DAY_RX=/^\s*(?:\d{4}|\d{2})[.\-_]\d{2}[.\-_]\d{2}(?:[.\-_](\d+))?/;
  function fallbackDateFromName(name){
    const s=String(name);
    let m=s.match(DATE_RX_YYYY);
    if(m){ const yyyy=Math.max(1970,Math.min(2100,parseInt(m[1],10)));
      const mm=Math.max(1,Math.min(12,parseInt(m[2],10)));
      const dd=Math.max(1,Math.min(31,parseInt(m[3],10)));
      return new Date(Date.UTC(yyyy,mm-1,dd));
    }
    m=s.match(DATE_RX_YY);
    if(m){ const yy=parseInt(m[1],10); const yyyy=(yy>=70?1900+yy:2000+yy);
      const mm=Math.max(1,Math.min(12,parseInt(m[2],10)));
      const dd=Math.max(1,Math.min(31,parseInt(m[3],10)));
      return new Date(Date.UTC(yyyy,mm-1,dd));
    }
    return null;
  }
  function withinDayIndexFromName(name){ const m=String(name).match(WITHIN_DAY_RX); return m&&m[1]?parseInt(m[1],10):0; }
  function bpmSortValue(t){ if(t.bpm!=null) return t.bpm; if(t.bpm_min!=null&&t.bpm_max!=null) return (t.bpm_min+t.bpm_max)/2; return 0; }
  function bpmLabel(t){ if(t.bpm!=null) return `${t.bpm} BPM`; if(t.bpm_min!=null&&t.bpm_max!=null) return `${t.bpm_min}–${t.bpm_max} BPM`; return ''; }

  /* ---------- Elements & State ---------- */
  const els = {
    audio:$('#audio'), list:$('#list'), sort:$('#sort'),
    toggle:$('#toggle'), prev:$('#prev'), next:$('#next'),
    seek:$('#seek'), vol:$('#vol'),
    nowTitle:$('#now-title'), nowSub:$('#now-sub'),
    tcur:$('#tcur'), tdur:$('#tdur'), cover:$('#cover'),
    menu:$('#menu'), toolbar:$('#toolbar')
  };

  const state = {
    tracks:[], filtered:[], i:-1, playing:false,
    pageSize:60, renderCount:0,
    titlesLookup:new Map(), thumbBases:new Set(), resolvedThumb:new Map(),
    showTitles:false, showWavButtons:false, showMovButtons:false,
    favorites:new Set(JSON.parse(localStorage.getItem('vvip25:favs')||'[]')),
    favOrder: JSON.parse(localStorage.getItem('vvip25:favOrder')||'[]'),
    searchQuery:''
  };

  // Persisted volume
  els.vol.value = localStorage.getItem('vvip25:vol') ?? '0.9';
  els.audio.volume = parseFloat(els.vol.value);

  /* ---------- Boot ---------- */
  init();
  async function init(){
    buildMenuUI();
    buildDownloadFooter();  // footer download button
    setControlIcons();      // bespoke SVG icons on player controls

    const mres = await fetch(`./manifest.json?v=${ASSET_VERSION}`, { cache:'no-store' });
    if(!mres.ok){ els.list.innerHTML = `<div class="row"><div></div><div>manifest.json missing</div></div>`; return; }
    const data = await mres.json();

    state.tracks = data.map((t,idx)=>{
      const name = t.name || t.file || t.src?.split('/').pop() || `track-${idx}.mp3`;
      const base = stripExt(name), baseLower = base.toLowerCase();
      const dateObj = t.date ? new Date(t.date) : fallbackDateFromName(name);
      const labelDate = dateObj ? dateObj.toISOString().slice(0,10) : '';
      const mp3 = t.src || (BASE_MP3 + encodeURIComponent(name));
      const wav = BASE_WAV + encodeURIComponent(base + '.wav');
      const mov = t.has_mov ? (BASE_VIDEO + encodeURIComponent(base + '.mov')) : null;
      const thumbCandidate = BASE_THUMB + encodeURIComponent(baseLower + 'thumb.jpg');

      // SEARCH TAGS: put #hashtags in "details" in manifest; we will index them but NOT show in the UI subline.
      const details = t.details || '';

      return { id:idx, name, base, baseLower, title: t.title?String(t.title):'',
        bpm:t.bpm??null, bpm_min:t.bpm_min??null, bpm_max:t.bpm_max??null,
        details, length:t.length||0,
        date:dateObj||null, labelDate, src:mp3, wav, video:mov, thumbCandidate };
    });

    applyFilterSort(true);
    computeThumbCascade();
    renderList();
    fillViewport();
    if (state.filtered.length && state.i === -1) { select(0); }

    (requestIdleCallback?.(fetchTitles,{timeout:600})||setTimeout(fetchTitles,0));
    (requestIdleCallback?.(fetchThumbs,{timeout:900})||setTimeout(fetchThumbs,50));
  }

  /* ---------- Titles (primary only) ---------- */
  function buildTitleLookup(json){
    const map=new Map();
    const add=(k,titleRaw)=>{ if(!k||!titleRaw) return; const title=primaryOnly(titleRaw);
      const rawLower=String(k).toLowerCase(); const justFile=rawFile(rawLower);
      const noExt=stripExt(justFile); const norm=softNorm(justFile);
      map.set(justFile,String(title)); map.set(noExt,String(title)); map.set(norm,String(title));
    };
    if (Array.isArray(json)){ for(const row of json||[]){ if(!row) continue; add(row.key||row.src||row.name, row.title||row.t||row.display); } }
    else if (json && typeof json==='object'){ for(const [k,v] of Object.entries(json)){ add(k, (typeof v==='string')?v:(v&&typeof v.title==='string'?v.title:'')); } }
    return map;
  }
  function bestTitleForTrack(t,lookup){
    const f=rawFile(t.name).toLowerCase(), noExt=stripExt(f), norm=softNorm(f), fromSrc=t.src?rawFile(t.src).toLowerCase():'';
    const candidates=[f,noExt,norm,fromSrc,stripExt(fromSrc),softNorm(fromSrc),t.base?.toLowerCase?.(),softNorm(t.base||'')].filter(Boolean);
    for(const c of candidates){ if(lookup.has(c)) return lookup.get(c); } return '';
  }
  async function fetchTitles(){
    try{
      const tres=await fetch(`./titles.json?v=${ASSET_VERSION}`,{cache:'no-store'});
      if(!tres.ok) return;
      const json=await tres.json();
      const lookup=buildTitleLookup(json);
      let changed=false;
      for(const t of state.tracks){
        const fromTitles=bestTitleForTrack(t,lookup);
        const finalTitle=fromTitles || t.title || deriveTitleFromFilename(t.name);
        if (finalTitle!==t.title){ t.title=finalTitle; changed=true; }
      }
      if (changed){ applyFilterSort(false,true); refreshTitles(); }
    }catch(_){}
  }

  /* ---------- Thumbs ---------- */
  async function fetchThumbs(){
    try{
      const r=await fetch(`./thumbs.json?v=${ASSET_VERSION}`,{cache:'no-store'});
      if(!r.ok) return;
      const data=await r.json();
      const set=new Set();
      if(Array.isArray(data)) data.forEach(b=>set.add(String(b).toLowerCase()));
      else if(data && typeof data==='object') Object.keys(data).forEach(b=>{ if(data[b]) set.add(b.toLowerCase()); });
      state.thumbBases=set; computeThumbCascade(); rerenderVisibleRowsThumbs(); if(state.i>=0) updateNowbar();
    }catch(_){}
  }
  function computeThumbCascade(){
    const asc=[...state.tracks].sort((a,b)=>{ const da=a.date?.getTime()||0, db=b.date?.getTime()||0;
      if(da!==db) return da-db;
      return withinDayIndexFromName(a.name)-withinDayIndexFromName(b.name) || a.name.localeCompare(b.name);
    });
    let currentThumb=DEFAULT_THUMB;
    for(const t of asc){ if(state.thumbBases.has(t.baseLower)) currentThumb=t.thumbCandidate; state.resolvedThumb.set(t.id,currentThumb); }
  }
  const getResolvedThumb=t=>state.resolvedThumb.get(t.id)||DEFAULT_THUMB;

  /* ---------- Filtering / sorting ---------- */
  function isNameless(t){ const derived=deriveTitleFromFilename(t.name); return !t.title || t.title===derived; }

  function applyFilterSort(firstPaint=false, keepIndex=false){
    const q=state.searchQuery.trim().toLowerCase();
    const tokens=q? q.split(/\s+/).filter(Boolean):[];
    let out=[...state.tracks];

    // favorites preset
    let favoritesOnly=false;
    if (tokens.includes('#favorites')){ favoritesOnly=true; out=out.filter(t=>state.favorites.has(t.name)); }

    // when titles ON, hide “nameless” (those where title==derived filename)
    if (state.showTitles){ out=out.filter(t=>!isNameless(t)); }

    // search on name/title/details (details includes #tags). We DO NOT show details in UI.
    out = out.filter(t=>{
      const hayName  =(t.name||'').toLowerCase();
      const hayTitle =(t.title||'').toLowerCase();
      const hayTags  =(t.details||'').toLowerCase(); // hidden field
      return tokens.every(tok=>{
        if (tok==='#favorites') return true;
        if (tok.startsWith('#')) return hayTags.includes(tok);
        return hayName.includes(tok) || hayTitle.includes(tok) || hayTags.includes(tok);
      });
    });

    // sorting
    if (favoritesOnly){
      const orderIndex=new Map(state.favOrder.map((name,idx)=>[name,idx]));
      out.sort((a,b)=>(orderIndex.get(a.name)??1e9)-(orderIndex.get(b.name)??1e9));
    } else {
      switch(els.sort?.value||'date_desc'){
        case 'date_desc': out.sort((a,b)=>{ const da=a.date?.getTime()||0, db=b.date?.getTime()||0;
          if (db!==da) return db-da; return withinDayIndexFromName(b.name)-withinDayIndexFromName(a.name) || b.name.localeCompare(a.name); }); break;
        case 'date_asc':  out.sort((a,b)=>{ const da=a.date?.getTime()||0, db=b.date?.getTime()||0;
          if (da!==db) return da-db; return withinDayIndexFromName(a.name)-withinDayIndexFromName(b.name) || a.name.localeCompare(b.name); }); break;
        case 'bpm_desc':  out.sort((a,b)=> bpmSortValue(b)-bpmSortValue(a)); break;
        case 'bpm_asc':   out.sort((a,b)=> bpmSortValue(a)-bpmSortValue(b)); break;
        case 'len_desc':  out.sort((a,b)=> (b.length||0)-(a.length||0)); break;
        case 'len_asc':   out.sort((a,b)=> (a.length||0)-(b.length||0)); break;
      }
    }

    state.filtered=out;
    const initialChunk=firstPaint ? Math.max(60,state.pageSize) : state.pageSize;
    state.renderCount=Math.min(state.filtered.length, initialChunk);
    if (!keepIndex) state.i=Math.min(state.i, state.renderCount-1);
    renderList(); setupInfiniteScroll(); fillViewport();
  }

  const displayName=t=>(state.showTitles && t.title) ? t.title : t.name;

  /* ---------- Renderers ---------- */
  function imgHTML(src){ const esc=s=>s.replace(/"/g,'&quot;');
    return `<img src="${esc(src)}" alt="" loading="lazy" style="width:56px;height:56px;border-radius:8px;object-fit:cover;" onerror="if(this.dataset.fbk!=='1'){this.dataset.fbk='1';this.onerror=null;this.src='${DEFAULT_THUMB}';}">`;
  }
  function favHTML(t){ const on=state.favorites.has(t.name)?'on':''; const title=state.favorites.has(t.name)?'Remove from favorites':'Add to favorites';
    return `<button class="star ${on}" data-fav="${escapeHTML(t.name)}" title="${title}">★</button>`;
  }
  function badgeHTML(t){
    const parts=[favHTML(t), `<a class="pill" href="${t.src}" download title="Download MP3">MP3</a>`];
    if (state.showWavButtons) parts.push(`<a class="pill" href="${BASE_WAV+encodeURIComponent(t.base+'.wav')}" download title="Download Lossless">WAV</a>`);
    if (state.showMovButtons && t.video) parts.push(`<a class="pill" href="${t.video}" target="_blank" rel="noopener" title="Open Video">MOV</a>`);
    if (state.showMovButtons && !t.video) parts.push('<span class="pill muted">MOV</span>');
    return `<div class="badge">${parts.join('\n')}</div>`;
  }
  function rowHTML(t,active){
    const bpmTxt=bpmLabel(t), thumbURL=getResolvedThumb(t);
    // IMPORTANT: do NOT include t.details (hidden tags) in the subline
    const subline=[ (state.showTitles? '' : (t.title||'')), bpmTxt, t.length?fmtDur(t.length):'', t.labelDate||'' ]
      .filter(Boolean).join(' · ');
    const hasTitleClass=(t.title && !isNameless(t)) ? 'has-title':'';
    return `<div class="row ${hasTitleClass}" role="listitem" data-id="${t.id}">
      <div class="cover" aria-hidden="true">${imgHTML(thumbURL)}</div>
      <div>
        <div class="title">${active?'▶︎ ':''}${escapeHTML(displayName(t))}</div>
        <div class="sub">${escapeHTML(subline)}</div>
      </div>
      ${badgeHTML(t)}
    </div>`;
  }
  function renderList(){
    if(!state.filtered.length){ els.list.innerHTML='<div class="row"><div></div><div>No results.</div></div>'; return; }
    const slice=state.filtered.slice(0,state.renderCount);
    els.list.innerHTML = slice.map(t=>rowHTML(t,(state.i>=0 && state.filtered[state.i]?.id===t.id))).join('') + `<div id="sentinel" style="height:1px"></div>`;
  }
  function rerenderVisibleRowsThumbs(){ const rows=els.list.querySelectorAll('.row');
    rows.forEach(row=>{ const id=Number(row.getAttribute('data-id')); const t=state.tracks.find(x=>x.id===id); if(!t) return;
      const img=row.querySelector('.cover img'); if(img) img.src=getResolvedThumb(t);
    });
  }
  function rerenderVisibleRowsBadges(){ const rows=document.querySelectorAll('.row');
    rows.forEach(row=>{ const id=Number(row.getAttribute('data-id')); const t=state.tracks.find(x=>x.id===id); if(!t) return;
      const badge=row.querySelector('.badge'); if(badge) badge.outerHTML=badgeHTML(t);
    });
  }
  function refreshTitles(){
    const rows=document.querySelectorAll('.row');
    rows.forEach(row=>{
      const id=Number(row.getAttribute('data-id')); const t=state.tracks.find(x=>x.id===id); if(!t) return;
      const titleEl=row.querySelector('.title'); const subEl=row.querySelector('.sub');
      if (titleEl){ const isActive=(state.i>=0 && state.filtered[state.i]?.id===id); titleEl.innerHTML=(isActive?'▶︎ ':'') + escapeHTML(displayName(t)); }
      if (subEl){
        const bpmTxt=bpmLabel(t);
        const subline=[ (state.showTitles? '' : (t.title||'')), bpmTxt, t.length?fmtDur(t.length):'', t.labelDate||'' ]
          .filter(Boolean).join(' · ');
        subEl.textContent=subline;
      }
      row.classList.toggle('has-title', (t.title && !isNameless(t)));
    });
    if (state.i>=0) updateNowbar();
    applyFilterSort(false,true);
  }

  /* ---------- Infinite scroll ---------- */
  let sentinelObserver;
  function setupInfiniteScroll(){
    const s=$('#sentinel'); if(!s) return;
    if(sentinelObserver) sentinelObserver.disconnect();
    if('IntersectionObserver' in window){
      sentinelObserver=new IntersectionObserver((entries)=>{ for(const e of entries){ if(e.isIntersecting) appendChunk(); } },{root:null,rootMargin:'1200px 0px',threshold:0});
      sentinelObserver.observe(s);
    }
    window.addEventListener('scroll', onScrollMaybeLoad, { passive:true });
    window.addEventListener('resize', debounce(fillViewport,120), { passive:true });
  }
  function appendChunk(){
    if (state.renderCount>=state.filtered.length) return;
    const prev=state.renderCount; state.renderCount=Math.min(state.filtered.length, state.renderCount+state.pageSize);
    const sentinel=$('#sentinel'); if(!sentinel) return;
    const frag=document.createDocumentFragment();
    for(let i=prev;i<state.renderCount;i++){
      const t=state.filtered[i]; const div=document.createElement('div'); div.innerHTML=rowHTML(t,(state.i>=0 && state.filtered[state.i]?.id===t.id)); frag.appendChild(div.firstChild);
    }
    els.list.insertBefore(frag, sentinel);
  }
  function atBottomBuffer(px=1200){ return (window.scrollY + window.innerHeight + px) >= document.documentElement.scrollHeight; }
  function onScrollMaybeLoad(){ if (atBottomBuffer()) appendChunk(); }
  function fillViewport(){
    let guard=0; while(guard++<10){ const scrollable=document.documentElement.scrollHeight>window.innerHeight+200;
      if (scrollable || state.renderCount>=state.filtered.length) break; appendChunk();
    }
  }

  /* ---------- Selection / Player ---------- */
  function select(indexInFiltered){
    state.i=indexInFiltered;
    const t=state.filtered[indexInFiltered]; if(!t) return;
    els.audio.src=t.src; updateNowbar(); state.playing=false; updateToggle(); setControlIcons(); // ensure correct icon
    const rendered=els.list.querySelectorAll('.row');
    rendered.forEach(row=>{
      const id=Number(row.getAttribute('data-id')); const isActive=(state.filtered[state.i]?.id===id);
      const titleEl=row.querySelector('.title'); if(titleEl){ const target=state.tracks.find(x=>x.id===id)||t; titleEl.innerHTML=(isActive?'▶︎ ':'') + escapeHTML(displayName(target)); }
      const favBtn=row.querySelector('.star[data-fav]'); if(favBtn){ const key=favBtn.getAttribute('data-fav'); favBtn.classList.toggle('on', state.favorites.has(key)); }
    });
  }
  function updateNowbar(){
    const t=state.filtered[state.i]; if(!t) return;
    els.nowTitle.textContent=displayName(t);
    const bpmTxt=bpmLabel(t);
    els.nowSub.textContent=[ (state.showTitles? '' : (t.title||'')), bpmTxt, t.length?fmtDur(t.length):'', t.labelDate||'' ]
      .filter(Boolean).join(' · ');
    const url=getResolvedThumb(t);
    els.cover.innerHTML=`<img src="${url.replace(/"/g,'&quot;')}" alt="" style="width:56px;height:56px;object-fit:cover;border-radius:8px" onerror="if(this.dataset.fbk!=='1'){this.dataset.fbk='1';this.onerror=null;this.src='${DEFAULT_THUMB}';}">`;
  }
  async function play(){
    try{
      await els.audio.play();
      state.playing=true; updateToggle(); setControlIcons();
      if('mediaSession' in navigator){
        const t=state.filtered[state.i];
        navigator.mediaSession.metadata=new MediaMetadata({ title:displayName(t) });
        navigator.mediaSession.setActionHandler('previoustrack', ()=>jump(-1));
        navigator.mediaSession.setActionHandler('nexttrack', ()=>jump(1));
        navigator.mediaSession.setActionHandler('seekbackward', ()=> els.audio.currentTime=Math.max(0,els.audio.currentTime-10));
        navigator.mediaSession.setActionHandler('seekforward',  ()=> els.audio.currentTime=Math.min(els.audio.duration||0,els.audio.currentTime+10));
      }
    }catch(_){}
  }
  function pause(){ els.audio.pause(); state.playing=false; updateToggle(); setControlIcons(); }
  function updateToggle(){ const btn=$('#toggle'); if(btn) btn.setAttribute('data-state', state.playing ? 'pause' : 'play'); }
  function jump(dir){ if(!state.filtered.length) return; let i=state.i+dir; if(i<0) i=state.filtered.length-1; if(i>=state.filtered.length) i=0; select(i); play(); }

  /* ---------- Bespoke SVG icons ---------- */
  function setControlIcons(){
    const svgPrev = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 5h2v14H6zM20 6v12L9 12z"/></svg>';
    const svgNext = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M16 5h2v14h-2zM4 6v12l11-6z"/></svg>';
    const svgPlay = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>';
    const svgPause= '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 5h4v14H7zM13 5h4v14h-4z"/></svg>';

    if (els.prev)   els.prev.innerHTML = svgPrev;
    if (els.next)   els.next.innerHTML = svgNext;
    if (els.toggle) els.toggle.innerHTML = (state.playing ? svgPause : svgPlay);
  }

  /* ---------- Menu / UI ---------- */
  function buildMenuUI(){
    const tb=els.toolbar; if(!tb) return; tb.innerHTML='';
    const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.flexWrap='wrap'; row.style.alignItems='center'; tb.appendChild(row);

    // 📜 About
    const btnAbout=document.createElement('button'); btnAbout.className='btn'; btnAbout.id='btnAbout'; btnAbout.title='About'; btnAbout.textContent='📜'; row.appendChild(btnAbout);
    btnAbout.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); alert("VVIP25 — Vancouver Music and Videography Project 2025"); keepMenuOpen(e); });

    // 🎵 Playlist (favorites view)
    const btnFavList=document.createElement('button'); btnFavList.className='btn'; btnFavList.id='btnFavList'; btnFavList.title='My favorites playlist'; btnFavList.textContent='🎵'; row.appendChild(btnFavList);
    btnFavList.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); state.searchQuery='#favorites'; applyFilterSort(false); keepMenuOpen(e); });

    // 🛠️ Utilities (titles/wav/mov/light)
    const btnUtils=document.createElement('button'); btnUtils.className='btn'; btnUtils.id='btnUtils'; btnUtils.title='Utilities'; btnUtils.textContent='🛠️'; row.appendChild(btnUtils);
    const util=document.createElement('div'); util.className='util-panel';
    util.innerHTML = `<div class="util-row">
      <button class="tog" id="togTitles" title="Song Titles (on/off)">📝</button>
      <button class="tog" id="togWav" title="Show WAV buttons">🎚️</button>
      <button class="tog" id="togMov" title="Show MOV buttons">🎬</button>
      <button class="tog" id="togLight" title="Light mode">🌞</button>
    </div>`;
    tb.appendChild(util);

    // 🔗 Links submenu
    const btnLinks=document.createElement('button'); btnLinks.className='btn'; btnLinks.id='btnLinks'; btnLinks.title='Links'; btnLinks.textContent='🔗'; row.appendChild(btnLinks);
    const links=document.createElement('div'); links.className='links-panel';
    links.innerHTML = `<div class="links-row">
      <a class="btn" href="https://www.youtube.com/@VVVVIIPP25" target="_blank" rel="noopener" title="YouTube">📺</a>
      <a class="btn" href="https://virtualvip.bandcamp.com/" target="_blank" rel="noopener" title="Bandcamp">🎧</a>
      <a class="btn" href="https://substack.com/home/post/p-170664918?source=queue" target="_blank" rel="noopener" title="Newsletter">📰</a>
      <a class="btn" href="https://www.instagram.com/virtualvip24/" target="_blank" rel="noopener" title="Instagram">📸</a>
    </div>`;
    tb.appendChild(links);

    // 🛍️ Shop → /shoppe
    const aShop=document.createElement('a'); aShop.className='btn'; aShop.id='btnShop'; aShop.title='Shoppe'; aShop.textContent='🛍️'; aShop.href='/shoppe'; aShop.target='_self'; row.appendChild(aShop);

    // Sort select
    const sortSel=document.createElement('select'); sortSel.id='sort'; sortSel.title='Sort';
    sortSel.innerHTML=`<option value="date_desc">Newest</option><option value="date_asc">Oldest</option><option value="bpm_desc">BPM ↓</option><option value="bpm_asc">BPM ↑</option><option value="len_desc">Longest</option><option value="len_asc">Shortest</option>`;
    row.appendChild(sortSel); els.sort=sortSel;

    // 🔍 Search
    const btnSearch=document.createElement('button'); btnSearch.className='btn'; btnSearch.id='btnSearch'; btnSearch.title='Search'; btnSearch.textContent='🔍'; row.appendChild(btnSearch);
    const searchWrap=document.createElement('div'); searchWrap.className='search-wrap'; searchWrap.innerHTML=`<input id="searchInput" placeholder="Search… use #tags (e.g. #mbv)" inputmode="search" />`; tb.appendChild(searchWrap);
    const searchInput=searchWrap.querySelector('#searchInput');
    btnSearch.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); searchWrap.style.display=(searchWrap.style.display==='none'||!searchWrap.style.display)?'flex':'none'; if(searchWrap.style.display==='flex'){ searchInput.value=state.searchQuery; searchInput.focus(); } keepMenuOpen(e); });
    searchInput.addEventListener('input', debounce(()=>{ state.searchQuery=searchInput.value||''; applyFilterSort(false,true); },150));

    // Toggle wiring
    const btnTitles=util.querySelector('#togTitles');
    const btnWav=util.querySelector('#togWav');
    const btnMov=util.querySelector('#togMov');
    const btnLight=util.querySelector('#togLight');
    function syncToggles(){
      btnTitles.classList.toggle('on',state.showTitles);
      btnWav.classList.toggle('on',state.showWavButtons);
      btnMov.classList.toggle('on',state.showMovButtons);
      btnLight.classList.toggle('on',document.body.classList.contains('light'));
    }
    syncToggles();
    btnTitles.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); state.showTitles=!state.showTitles; syncToggles(); refreshTitles(); keepMenuOpen(e); });
    btnWav.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); state.showWavButtons=!state.showWavButtons; syncToggles(); rerenderVisibleRowsBadges(); if(state.i>=0) updateNowbar(); keepMenuOpen(e); });
    btnMov.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); state.showMovButtons=!state.showMovButtons; syncToggles(); rerenderVisibleRowsBadges(); if(state.i>=0) updateNowbar(); keepMenuOpen(e); });
    btnLight.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); document.body.classList.toggle('light'); syncToggles(); keepMenuOpen(e); });

    btnUtils.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation();
      util.style.display=(util.style.display==='none'||!util.style.display)?'block':'none'; keepMenuOpen(e);
    });
    btnLinks.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation();
      links.style.display=(links.style.display==='none'||!links.style.display)?'block':'none'; keepMenuOpen(e);
    });

    // Keep menu open unless clicking a real link
    tb.addEventListener('click', keepMenuOpen);
  }
  function keepMenuOpen(e){
    if (!els.menu) return;
    // if it's an anchor, let it navigate
    if (e && e.target && e.target.closest && e.target.closest('a')) return;
    if (e){ e.preventDefault?.(); e.stopPropagation?.(); }
    els.menu.open=true;
  }

  /* ---------- Footer Download (M3U + up to 10 MP3s) ---------- */
  function buildDownloadFooter(){
    const wrap = document.querySelector('.wrap:last-of-type'); // the second wrap with the list
    if (!wrap) return;
    let bar = document.createElement('div');
    bar.id = 'dlbar';
    bar.innerHTML = `<button class="btn" id="btnDl"><span>⬇️</span> Download playlist <small>(.m3u + up to 10 MP3s)</small></button>`;
    wrap.appendChild(bar);

    $('#btnDl').addEventListener('click', async (e)=>{
      e.preventDefault(); e.stopPropagation();
      const view = state.filtered.slice(); // current view
      if (!view.length){ alert('Nothing to download.'); return; }

      // 1) Always export M3U (full current view)
      const m3uLines = ['#EXTM3U', ...view.map(t => t.src)];
      const m3u = m3uLines.join('\n');
      const blob = new Blob([m3u], {type:'audio/x-mpegurl'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download='vvip25-playlist.m3u'; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);

      // 2) Offer to fetch up to 10 MP3s (in playlist order)
      const limit = Math.min(10, view.length);
      if (confirm(`Also download up to ${limit} MP3s now? (Your browser may request permission for multiple downloads.)`)){
        for (let i=0;i<limit;i++){
          const t=view[i], url=t.src;
          try{
            const resp=await fetch(url,{mode:'cors'}); if(!resp.ok) throw new Error('HTTP '+resp.status);
            const b=await resp.blob();
            const fname=decodeURIComponent(url.split('/').pop()||`track-${i+1}.mp3`);
            const link=document.createElement('a');
            link.href=URL.createObjectURL(b); link.download=fname; document.body.appendChild(link); link.click(); link.remove();
            setTimeout(()=>URL.revokeObjectURL(link.href), 2000);
          }catch(err){
            console.warn('Skip download:', url, err);
          }
        }
      }
    });
  }

  /* ---------- Events ---------- */
  document.addEventListener('click',(e)=>{
    const favBtn=e.target.closest?.('.star');
    if (favBtn && favBtn.hasAttribute('data-fav')){
      const key=favBtn.getAttribute('data-fav'); const wasFav=state.favorites.has(key);
      if (wasFav){ state.favorites.delete(key); state.favOrder=state.favOrder.filter(n=>n!==key); }
      else { state.favorites.add(key); if(!state.favOrder.includes(key)) state.favOrder.push(key); }
      localStorage.setItem('vvip25:favs', JSON.stringify(Array.from(state.favorites)));
      localStorage.setItem('vvip25:favOrder', JSON.stringify(state.favOrder));
      favBtn.classList.toggle('on', !wasFav);
      e.preventDefault(); e.stopPropagation(); return;
    }
    const row=e.target.closest?.('.row');
    if(row && !e.target.closest('a')){
      const id=Number(row.getAttribute('data-id')); const idx=state.filtered.findIndex(t=>t.id===id);
      if(idx>=0){ select(idx); play(); }
    }
  }, { passive:false });

  document.addEventListener('change',(e)=>{ if (e.target && e.target.id==='sort'){ applyFilterSort(false,true); keepMenuOpen(e); } }, { passive:true });

  $('#toggle')?.addEventListener('click', ()=>{ if (state.i<0 && state.filtered.length) select(0); state.playing?pause():play(); }, { passive:true });
  els.prev?.addEventListener('click', ()=> jump(-1), { passive:true });
  els.next?.addEventListener('click', ()=> jump(1), { passive:true });

  els.audio.addEventListener('timeupdate', ()=>{ const a=els.audio; if(!isFinite(a.duration)) return; els.seek.max=Math.floor(a.duration); els.seek.value=Math.floor(a.currentTime); $('#tcur').textContent=fmtDur(a.currentTime); $('#tdur').textContent=isFinite(a.duration)?fmtDur(a.duration):'0:00'; });
  els.seek.addEventListener('input', ()=>{ els.audio.currentTime=Number(els.seek.value); });
  els.vol.addEventListener('input', ()=>{ els.audio.volume=parseFloat(els.vol.value); localStorage.setItem('vvip25:vol', els.vol.value); });
  els.audio.addEventListener('ended', ()=> jump(1));

</script>
</body>
</html>