<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VVIP25</title>
  <link rel="icon" type="image/png" sizes="64x64" href="/favicon-64.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" href="/favicon.ico?v=3">
  <meta name="theme-color" content="#0b0b0c" />
  <style>
    :root{--bg:#0b0b0c;--fg:#eceff4;--muted:#9aa0a6;--card:#141416;--border:#26272b;--accent:#6ee7b7}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,"Segoe UI",Roboto,Inter,system-ui,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:16px}

    header{display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative}
    #site-title{margin:0;font-size:56px;font-weight:bold;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;color:transparent;-webkit-text-fill-color:transparent;-webkit-text-stroke:2px #fdf6d0}

    .player{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,11,12,.97),rgba(11,11,12,.92));backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--border)}
    .now{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:12px 0}
    .cover{width:56px;height:56px;border-radius:8px;background:#1e1f24;display:grid;place-items:center;color:var(--muted);font-weight:700;border:1px solid var(--border)}
    .meta{min-width:0}
    .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .controls{display:flex;align-items:center;gap:8px}
    button{appearance:none;background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .range{display:flex;align-items:center;gap:8px}
    input[type="range"]{width:160px}
    .list{margin:12px 0 40px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .row{display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center;padding:10px 12px;border-top:1px solid var(--border);background:var(--card);min-height:78px}
    .row:first-child{border-top:0}
    .row:hover{background:#17171b}
    .badge{display:flex;gap:10px;align-items:center;font-size:12px;justify-self:end}
    .badge a{color:var(--fg);text-decoration:none;border:1px solid var(--border);padding:4px 8px;border-radius:8px}
    .badge .muted{color:var(--muted)}
    .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas;background:#1b1c20;border:1px solid #2a2b30;border-radius:6px;padding:2px 6px;color:#d7dae0}

    /* Toolbar + toggles */
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .tog,.btn{
      display:inline-flex;align-items:center;justify-content:center;
      height:36px;min-width:36px;padding:0 10px;
      border-radius:10px;border:1px solid var(--border);background:var(--card);
      text-decoration:none;color:var(--fg);line-height:1
    }
    .tog{opacity:.6;transition:opacity .15s, box-shadow .15s}
    .tog.on{opacity:1;box-shadow:0 0 0 2px var(--accent) inset}

    /* Hamburger (overlay) */
    details.menu{position:static}
    details.menu>summary{cursor:pointer;list-style:none;background:var(--card);border:1px solid var(--border);padding:8px 12px;border-radius:10px;user-select:none}
    .sheet{position:absolute;top:calc(100% + 8px);right:0;z-index:20;width:min(420px,calc(100vw - 32px));background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;display:none;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    details.menu[open]>.sheet{display:block}
    details.menu[open]>summary{border-bottom-left-radius:10px;border-bottom-right-radius:10px}

    /* Hide the volume control on iOS Safari */
    @supports (-webkit-touch-callout:none){.range[title="Volume"]{display:none !important}}

    @media (max-width:560px){
      .now{grid-template-columns:1fr;gap:8px}
      .cover{display:none}
      .controls{flex-wrap:wrap}
      .range input[type="range"]{width:120px}
      .row{grid-template-columns:1fr auto}
    }
  </style>
</head>
<body>
  <div class="player">
    <div class="wrap">
      <header>
        <h1 id="site-title">VVIP25</h1>
        <details class="menu" id="menu">
          <summary>☰ Menu</summary>
          <div class="sheet">
            <div class="toolbar" id="toolbar">
              <select id="sort" title="Sort">
                <option value="date_desc">Newest</option>
                <option value="date_asc">Oldest</option>
                <option value="bpm_desc">BPM ↓</option>
                <option value="bpm_asc">BPM ↑</option>
                <option value="len_desc">Longest</option>
                <option value="len_asc">Shortest</option>
              </select>
              <button class="tog on" id="togTitles" title="Song Titles (on/off)">📝</button>
              <button class="tog" id="togWav" title="Show WAV buttons">🎚️</button>
              <button class="tog" id="togMov" title="Show MOV buttons">🎬</button>
              <button class="btn" id="btnAbout" title="About">ℹ️</button>
              <a class="btn" id="btnShop" href="/shop" target="_blank" rel="noopener" title="Shop">🛍️</a>
            </div>
          </div>
        </details>
      </header>

      <div class="now">
        <div class="cover" id="cover">V25</div>
        <div class="meta">
          <div class="title" id="now-title">—</div>
          <div class="sub" id="now-sub">Ready</div>
        </div>
        <div class="controls">
          <button id="prev" aria-label="Previous">⏮️</button>
          <button id="toggle" aria-label="Play/Pause">▶️</button>
          <button id="next" aria-label="Next">⏭️</button>
          <div class="range">
            <span id="tcur">0:00</span>
            <input id="seek" type="range" min="0" max="100" value="0" step="1" aria-label="Seek" />
            <span id="tdur">0:00</span>
          </div>
          <div class="range" title="Volume">
            <span>🔊</span>
            <input id="vol" type="range" min="0" max="1" step="0.01" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="list" class="list" role="list"></div>
  </div>

  <audio id="audio" preload="metadata"></audio>

<script>
/* ===== VVIP25 — Stable pared-back build ===== */

const ASSET_VERSION = 13; // bump for cache-busting of JSON

/* ---- Config ---- */
const BASE_MP3   = 'https://media.vvipmedia.net/ACCESS/';
const BASE_WAV   = 'https://media.vvipmedia.net/WAV/';
const BASE_THUMB = 'https://media.vvipmedia.net/ACCESS/';
const BASE_VIDEO = 'https://media.vvipmedia.net/VIDEOS/';
const DEFAULT_THUMB = BASE_THUMB + 'default_thumb.jpg';

/* ---- Light cache hint for HTML (media stays cached) ---- */
(() => { try {
  const m = document.createElement('meta');
  m.httpEquiv = 'Cache-Control';
  m.content = 'no-store, max-age=0, must-revalidate';
  document.head.appendChild(m);
} catch(_){} })();

/* ---- Minimal CSS patches (layout + menus) ---- */
(() => {
  const css = `
  .controls{flex-wrap:wrap;gap:10px}
  .controls .range{min-width:140px;flex:1}
  .controls .range input[type="range"]{width:100%}
  .btn,.tog{display:inline-flex;align-items:center;justify-content:center;height:36px;min-width:36px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--fg);text-decoration:none;line-height:1;cursor:pointer}
  .tog{opacity:.75;transition:opacity .15s, box-shadow .15s}
  .tog.on{opacity:1;box-shadow:0 0 0 2px var(--accent) inset}
  .panel{display:none;margin-top:8px;border:1px solid var(--border);border-radius:10px;padding:8px}
  .row-flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .search-wrap{display:none;gap:8px;align-items:center;margin-top:8px}
  .search-wrap input{flex:1;min-width:140px;background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
  .pill{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;text-decoration:none;color:var(--fg)}
  .star{cursor:pointer}
  .star.on{filter:drop-shadow(0 0 2px var(--accent)) brightness(1.1)}
  body.light{--bg:#f7f7f8;--fg:#111;--muted:#4b5563;--card:#ffffff;--border:#d1d5db;--accent:#2563eb}
  body.light .player{background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.92))}
  body.light #site-title{-webkit-text-stroke:2px #111}
  body.light .row.has-title .title{padding-left:8px}
  @media (max-width:560px){.controls{gap:6px}.controls button{flex:0 0 44px}.range span{min-width:34px;text-align:center}}
  `;
  const style = document.createElement('style');
  style.textContent = css;
  document.head.appendChild(style);
})();

/* ---- Helpers ---- */
const $ = s => document.querySelector(s);
const $mk = (tag, attrs={}) => Object.assign(document.createElement(tag), attrs);
function fmtDur(sec){sec=Number(sec||0);const m=Math.floor(sec/60),s=Math.floor(sec%60);return `${m}:${String(s).padStart(2,'0')}`;}
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
function escapeHTML(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function uniqJoin(parts){const seen=new Set(),out=[];for(let raw of parts){if(raw==null)continue;raw=String(raw).replace(/\b\d+(?:\.\d+)?(?:\s*[–—-]\s*\d+(?:\.\d+)?)?\s*BPM\b/gi,'').replace(/^[·•,;:\-]+|[·•,;:\-]+$/g,'').replace(/\s{2,}/g,' ').trim();if(!raw)continue;const k=raw.toLowerCase();if(seen.has(k))continue;seen.add(k);out.push(raw);}return out.join(' · ');}
const rawFile=s=>(String(s).split('/').pop()||'');
const stripExt=s=>String(s).replace(/\.[a-z0-9]+$/i,'');
const softNorm=s=>stripExt(s).toLowerCase().replace(/[ _]+/g,'-').replace(/-+/g,'-');
function deriveTitleFromFilename(name){const b=stripExt(rawFile(name)).replace(/^[\d._-]+/,'').replace(/[_-]+/g,' ').trim();return b || stripExt(rawFile(name));}
const primaryOnly = t => String(t||'').split('//')[0].trim();

/* ---- Date parsing for sort/thumb cascade ---- */
const DATE_RX_YYYY=/^\s*(\d{4})[.\-_](\d{2})[.\-_](\d{2})(?=\D|$)/;
const DATE_RX_YY=/^\s*(\d{2})[.\-_](\d{2})[.\-_](\d{2})(?=\D|$)/;
const WITHIN_DAY_RX=/^\s*(?:\d{4}|\d{2})[.\-_]\d{2}[.\-_]\d{2}(?:[.\-_](\d+))?/;
function fallbackDateFromName(name){
  const s=String(name); let m=s.match(DATE_RX_YYYY);
  if(m){const yyyy=Math.max(1970,Math.min(2100,parseInt(m[1],10))),mm=Math.max(1,Math.min(12,parseInt(m[2],10))),dd=Math.max(1,Math.min(31,parseInt(m[3],10)));
    return new Date(Date.UTC(yyyy,mm-1,dd));
  }
  m=s.match(DATE_RX_YY);
  if(m){const yy=parseInt(m[1],10),yyyy=(yy>=70?1900+yy:2000+yy),mm=Math.max(1,Math.min(12,parseInt(m[2],10))),dd=Math.max(1,Math.min(31,parseInt(m[3],10)));
    return new Date(Date.UTC(yyyy,mm-1,dd));
  }
  return null;
}
function withinDayIndexFromName(name){ const m=String(name).match(WITHIN_DAY_RX); return m&&m[1]?parseInt(m[1],10):0; }
function bpmSortValue(t){ if(t.bpm!=null) return t.bpm; if(t.bpm_min!=null&&t.bpm_max!=null) return (t.bpm_min+t.bpm_max)/2; return 0; }
function bpmLabel(t){ if(t.bpm!=null) return `${t.bpm} BPM`; if(t.bpm_min!=null&&t.bpm_max!=null) return `${t.bpm_min}–${t.bpm_max} BPM`; return ''; }

/* ---- Elements ---- */
const els = {
  audio: $('#audio'), list: $('#list'), menu: $('#menu'),
  sort: $('#sort'), toggle: $('#toggle'), prev: $('#prev'), next: $('#next'),
  seek: $('#seek'), vol: $('#vol'),
  nowTitle: $('#now-title'), nowSub: $('#now-sub'), cover: $('#cover'),
  toolbar: $('#toolbar')
};

/* ---- State ---- */
const state = {
  tracks: [], filtered: [], i: -1, playing: false,
  pageSize: 60, renderCount: 0,
  titlesLookup: new Map(), thumbBases: new Set(), resolvedThumb: new Map(),
  showTitles: false, showWavButtons: false, showMovButtons: false, lightMode: false,
  favorites: new Set(JSON.parse(localStorage.getItem('vvip25:favs')||'[]')),
  favOrder: JSON.parse(localStorage.getItem('vvip25:favOrder')||'[]'),
  searchQuery: ''
};

/* ---- Persisted volume ---- */
els.vol.value = localStorage.getItem('vvip25:vol') ?? '0.9';
els.audio.volume = parseFloat(els.vol.value);

/* ==== Boot ==== */
init();
async function init(){
  buildMenuUI();

  // Fetch manifest
  let resp;
  try {
    resp = await fetch(`./manifest.json?v=${ASSET_VERSION}`, { cache: 'no-store' });
  } catch (e) {
    showError('Could not request manifest.json'); return;
  }
  if (!resp.ok) { showError('manifest.json missing or blocked'); return; }

  let data;
  try { data = await resp.json(); } catch(e){ showError('manifest.json is not valid JSON'); return; }

  // Build track objects
  state.tracks = (data||[]).map((t,idx)=>{
    const name = t.name || t.file || t.src?.split('/').pop() || `track-${idx}.mp3`;
    const base = stripExt(name), baseLower = base.toLowerCase();
    const dateObj = t.date ? new Date(t.date) : fallbackDateFromName(name);
    const labelDate = dateObj ? dateObj.toISOString().slice(0,10) : '';
    const mp3 = t.src || (BASE_MP3 + encodeURIComponent(name));
    const wav = BASE_WAV + encodeURIComponent(base + '.wav');
    const mov = t.has_mov ? (BASE_VIDEO + encodeURIComponent(base + '.mov')) : null;
    const thumbCandidate = BASE_THUMB + encodeURIComponent(baseLower + 'thumb.jpg');

    let notes=''; if (Array.isArray(t.notes)) notes=t.notes.join(' '); else if (typeof t.notes==='string') notes=t.notes;

    return { id:idx, name, base, baseLower, title: t.title?String(t.title):'',
      bpm:t.bpm??null, bpm_min:t.bpm_min??null, bpm_max:t.bpm_max??null, details:t.details||'',
      length:t.length||0, date:dateObj||null, labelDate, src:mp3, wav, video:mov, thumbCandidate, notes:notes||'' };
  });

  // Titles + thumbs lazy
  (requestIdleCallback?.(fetchTitles,{timeout:600})||setTimeout(fetchTitles,0));
  (requestIdleCallback?.(fetchThumbs,{timeout:900})||setTimeout(fetchThumbs,50));

  // Render
  applyFilterSort(true);
  computeThumbCascade();
  renderList();
  fillViewport();
  if (state.filtered.length && state.i === -1) select(0);

  // Restore persisted light
  if (localStorage.getItem('vvip25:light') === '1'){ state.lightMode=true; document.body.classList.add('light'); }
}

/* ---- Error helper ---- */
function showError(msg){
  els.list.innerHTML = `<div class="row"><div></div><div>${escapeHTML(msg)}</div></div>`;
}

/* ---- Titles (primary only) ---- */
function buildTitleLookup(json){
  const map=new Map();
  const add=(k,titleRaw)=>{ if(!k||!titleRaw) return; const title=primaryOnly(titleRaw);
    const L=String(k).toLowerCase(), f=rawFile(L), n=stripExt(f), s=softNorm(f);
    map.set(f,String(title)); map.set(n,String(title)); map.set(s,String(title));
  };
  if (Array.isArray(json)) (json||[]).forEach(row=> add(row?.key||row?.src||row?.name, row?.title||row?.t||row?.display));
  else if (json && typeof json==='object') Object.entries(json).forEach(([k,v])=> add(k, (typeof v==='string')?v:(v&&v.title)));
  return map;
}
function bestTitleForTrack(t,lookup){
  const f=rawFile(t.name).toLowerCase(), n=stripExt(f), s=softNorm(f), fs=t.src?rawFile(t.src).toLowerCase():'';
  const cands=[f,n,s,fs,stripExt(fs),softNorm(fs),t.base?.toLowerCase?.(),softNorm(t.base||'')].filter(Boolean);
  for(const c of cands){ if(lookup.has(c)) return lookup.get(c); } return '';
}
async function fetchTitles(){
  try{
    const r=await fetch(`./titles.json?v=${ASSET_VERSION}`,{cache:'no-store'}); if(!r.ok) return;
    const json=await r.json(); const lookup=buildTitleLookup(json); state.titlesLookup=lookup;
    let changed=false;
    for(const t of state.tracks){
      const from=bestTitleForTrack(t,lookup);
      const fin=from || t.title || deriveTitleFromFilename(t.name);
      if (fin!==t.title){ t.title=fin; changed=true; }
    }
    if (changed){ applyFilterSort(false,true); refreshTitles(); }
  }catch(_){}
}

/* ---- Thumbs ---- */
async function fetchThumbs(){
  try{
    const r=await fetch(`./thumbs.json?v=${ASSET_VERSION}`,{cache:'no-store'}); if(!r.ok) return;
    const data=await r.json(); const set=new Set();
    if(Array.isArray(data)) data.forEach(b=>set.add(String(b).toLowerCase()));
    else if(data && typeof data==='object') Object.keys(data).forEach(b=>{ if(data[b]) set.add(b.toLowerCase()); });
    state.thumbBases=set; computeThumbCascade(); rerenderVisibleRowsThumbs(); if(state.i>=0) updateNowbar();
  }catch(_){}
}
function computeThumbCascade(){
  const asc=[...state.tracks].sort((a,b)=>{ const da=a.date?.getTime()||0, db=b.date?.getTime()||0;
    if(da!==db) return da-db;
    return withinDayIndexFromName(a.name)-withinDayIndexFromName(b.name) || a.name.localeCompare(b.name);
  });
  let current=DEFAULT_THUMB;
  for(const t of asc){ if(state.thumbBases.has(t.baseLower)) current=t.thumbCandidate; state.resolvedThumb.set(t.id,current); }
}
const getResolvedThumb=t=>state.resolvedThumb.get(t.id)||DEFAULT_THUMB;

/* ---- Filtering / sorting ---- */
function isNameless(t){ const derived=deriveTitleFromFilename(t.name); return !t.title || t.title===derived; }
function matchesSearch(t, tokens){
  if(!tokens.length) return true;
  const hn=(t.name||'').toLowerCase(), ht=(t.title||'').toLowerCase(), hno=(t.notes||'').toLowerCase();
  return tokens.every(tok=> tok.startsWith('#') ? hno.includes(tok) : (hn.includes(tok)||ht.includes(tok)||hno.includes(tok)));
}
function applyFilterSort(first=false, keepIndex=false){
  const q=state.searchQuery.trim().toLowerCase();
  const tokens=q? q.split(/\s+/).filter(Boolean):[];
  let out=[...state.tracks];

  let favOnly = tokens.includes('#favorites');
  if (favOnly) out = out.filter(t=>state.favorites.has(t.name));
  if (state.showTitles) out = out.filter(t=>!isNameless(t));
  out = out.filter(t=>matchesSearch(t, tokens.filter(tk=>tk!=='#favorites')));

  if (favOnly){
    const orderIndex=new Map(state.favOrder.map((name,idx)=>[name,idx]));
    out.sort((a,b)=>(orderIndex.get(a.name)??1e9)-(orderIndex.get(b.name)??1e9));
  } else {
    switch(els.sort?.value||'date_desc'){
      case 'date_desc': out.sort((a,b)=>{const da=a.date?.getTime()||0,db=b.date?.getTime()||0;if(db!==da)return db-da;return withinDayIndexFromName(b.name)-withinDayIndexFromName(a.name)||b.name.localeCompare(a.name);}); break;
      case 'date_asc':  out.sort((a,b)=>{const da=a.date?.getTime()||0,db=b.date?.getTime()||0;if(da!==db)return da-db;return withinDayIndexFromName(a.name)-withinDayIndexFromName(b.name)||a.name.localeCompare(b.name);}); break;
      case 'bpm_desc':  out.sort((a,b)=> bpmSortValue(b)-bpmSortValue(a)); break;
      case 'bpm_asc':   out.sort((a,b)=> bpmSortValue(a)-bpmSortValue(b)); break;
      case 'len_desc':  out.sort((a,b)=> (b.length||0)-(a.length||0)); break;
      case 'len_asc':   out.sort((a,b)=> (a.length||0)-(b.length||0)); break;
    }
  }

  state.filtered=out;
  const initial = first ? Math.max(60, state.pageSize) : state.pageSize;
  state.renderCount = Math.min(state.filtered.length, initial);
  if (!keepIndex) state.i = Math.min(state.i, state.renderCount-1);
  renderList(); setupInfiniteScroll(); fillViewport();
}
const displayName = t => (state.showTitles && t.title) ? t.title : t.name;

/* ---- Renderers ---- */
function imgHTML(src){const esc=s=>s.replace(/"/g,'&quot;');return `<img src="${esc(src)}" alt="" loading="lazy" style="width:56px;height:56px;border-radius:8px;object-fit:cover;" onerror="if(this.dataset.fbk!=='1'){this.dataset.fbk='1';this.onerror=null;this.src='${DEFAULT_THUMB}';}">`; }
function favHTML(t){ const on=state.favorites.has(t.name)?'on':''; const title=state.favorites.has(t.name)?'Remove from favorites':'Add to favorites';
  return `<button class="star ${on}" data-fav="${escapeHTML(t.name)}" title="${title}">★</button>`;
}
function badgeHTML(t){
  const parts=[favHTML(t), `<a class="pill" href="${t.src}" download title="Download MP3">MP3</a>`];
  if (state.showWavButtons) parts.push(`<a class="pill" href="${BASE_WAV+encodeURIComponent(t.base+'.wav')}" download title="Download Lossless">WAV</a>`);
  if (state.showMovButtons && t.video) parts.push(`<a class="pill" href="${t.video}" target="_blank" rel="noopener" title="Open Video">MOV</a>`);
  if (state.showMovButtons && !t.video) parts.push('<span class="pill muted">MOV</span>');
  return `<div class="badge">${parts.join('\n')}</div>`;
}
function rowHTML(t, active){
  const thumbURL=getResolvedThumb(t), bpmTxt=bpmLabel(t);
  const subline=uniqJoin([ state.showTitles? '' : (t.title||''), bpmTxt, t.length?fmtDur(t.length):'', t.details||'', t.notes||'' ]);
  const hasTitleClass=(t.title && !isNameless(t)) ? 'has-title' : '';
  return `<div class="row ${hasTitleClass}" role="listitem" data-id="${t.id}">
    <div class="cover" aria-hidden="true">${imgHTML(thumbURL)}</div>
    <div>
      <div class="title">${active?'▶︎ ':''}${escapeHTML(displayName(t))}</div>
      <div class="sub">${escapeHTML(subline)}</div>
    </div>
    ${badgeHTML(t)}
  </div>`;
}
function renderList(){
  if(!state.filtered.length){ els.list.innerHTML='<div class="row"><div></div><div>No results.</div></div>'; return; }
  const slice = state.filtered.slice(0, state.renderCount);
  els.list.innerHTML = slice.map(t=>rowHTML(t,(state.i>=0 && state.filtered[state.i]?.id===t.id))).join('') + `<div id="sentinel" style="height:1px"></div>`;
}
function rerenderVisibleRowsThumbs(){
  els.list.querySelectorAll('.row').forEach(row=>{
    const id=Number(row.getAttribute('data-id')); const t=state.tracks.find(x=>x.id===id); if(!t) return;
    const img=row.querySelector('.cover img'); if(img) img.src=getResolvedThumb(t);
  });
}
function rerenderVisibleRowsBadges(){
  document.querySelectorAll('.row').forEach(row=>{
    const id=Number(row.getAttribute('data-id')); const t=state.tracks.find(x=>x.id===id); if(!t) return;
    const badge=row.querySelector('.badge'); if(badge) badge.outerHTML=badgeHTML(t);
  });
}
function refreshTitles(){
  document.querySelectorAll('.row').forEach(row=>{
    const id=Number(row.getAttribute('data-id')); const t=state.tracks.find(x=>x.id===id); if(!t) return;
    const titleEl=row.querySelector('.title'); const subEl=row.querySelector('.sub');
    if (titleEl){ const isActive=(state.i>=0 && state.filtered[state.i]?.id===id); titleEl.innerHTML=(isActive?'▶︎ ':'') + escapeHTML(displayName(t)); }
    if (subEl){
      const bpmTxt=bpmLabel(t);
      const subline=uniqJoin([ state.showTitles? '' : (t.title||''), bpmTxt, t.length?fmtDur(t.length):'', t.details||'', t.notes||'' ]);
      subEl.textContent=subline;
    }
    row.classList.toggle('has-title', (t.title && !isNameless(t)));
  });
  if (state.i>=0) updateNowbar();
  applyFilterSort(false,true);
}

/* ---- Infinite scroll ---- */
let sentinelObserver;
function setupInfiniteScroll(){
  const s=$('#sentinel'); if(!s) return;
  if (sentinelObserver) sentinelObserver.disconnect();
  if ('IntersectionObserver' in window){
    sentinelObserver=new IntersectionObserver((ents)=>{for(const e of ents){if(e.isIntersecting) appendChunk();}}, {root:null,rootMargin:'1200px 0px',threshold:0});
    sentinelObserver.observe(s);
  }
  window.addEventListener('scroll', onScrollMaybeLoad, { passive:true });
  window.addEventListener('resize', debounce(fillViewport,120), { passive:true });
}
function appendChunk(){
  if (state.renderCount>=state.filtered.length) return;
  const prev=state.renderCount; state.renderCount=Math.min(state.filtered.length, state.renderCount+state.pageSize);
  const sentinel=$('#sentinel'); if(!sentinel) return;
  const frag=document.createDocumentFragment();
  for (let i=prev;i<state.renderCount;i++){
    const t=state.filtered[i]; const div=document.createElement('div'); div.innerHTML=rowHTML(t,(state.i>=0 && state.filtered[state.i]?.id===t.id)); frag.appendChild(div.firstChild);
  }
  els.list.insertBefore(frag, sentinel);
}
function atBottomBuffer(px=1200){ return (window.scrollY + window.innerHeight + px) >= document.documentElement.scrollHeight; }
function onScrollMaybeLoad(){ if (atBottomBuffer()) appendChunk(); }
function fillViewport(){
  let guard=0; while(guard++<10){ const scrollable=document.documentElement.scrollHeight>window.innerHeight+200;
    if (scrollable || state.renderCount>=state.filtered.length) break; appendChunk();
  }
}

/* ---- Selection / Player ---- */
function select(indexInFiltered){
  state.i=indexInFiltered;
  const t=state.filtered[indexInFiltered]; if(!t) return;
  els.audio.src=t.src;
  updateNowbar();
  state.playing=false;
  updateToggle();

  els.list.querySelectorAll('.row').forEach(row=>{
    const id=Number(row.getAttribute('data-id'));
    const isActive=(state.filtered[state.i]?.id===id);
    const titleEl=row.querySelector('.title');
    if (titleEl){
      const target=state.tracks.find(x=>x.id===id)||t;
      titleEl.innerHTML=(isActive?'▶︎ ':'') + escapeHTML(displayName(target));
    }
    const favBtn=row.querySelector('.star[data-fav]');
    if (favBtn){
      const key=favBtn.getAttribute('data-fav');
      favBtn.classList.toggle('on', state.favorites.has(key));
    }
  });
}
function updateNowbar(){
  const t=state.filtered[state.i]; if(!t) return;
  els.nowTitle.textContent=displayName(t);
  const bpmTxt=bpmLabel(t);
  els.nowSub.textContent=uniqJoin([ state.showTitles? '' : (t.title||''), bpmTxt, t.length?fmtDur(t.length):'', t.details||'', t.notes||'' ]);
  const url=getResolvedThumb(t);
  els.cover.innerHTML=`<img src="${url.replace(/"/g,'&quot;')}" alt="" style="width:56px;height:56px;border-radius:8px;object-fit:cover;" onerror="if(this.dataset.fbk!=='1'){this.dataset.fbk='1';this.onerror=null;this.src='${DEFAULT_THUMB}';}">`;
}
async function play(){
  try{
    await els.audio.play();
    state.playing=true; updateToggle();
    if('mediaSession' in navigator){
      const t=state.filtered[state.i];
      navigator.mediaSession.metadata=new MediaMetadata({ title:displayName(t) });
      navigator.mediaSession.setActionHandler('previoustrack', ()=>jump(-1));
      navigator.mediaSession.setActionHandler('nexttrack', ()=>jump(1));
      navigator.mediaSession.setActionHandler('seekbackward', ()=> els.audio.currentTime=Math.max(0,els.audio.currentTime-10));
      navigator.mediaSession.setActionHandler('seekforward',  ()=> els.audio.currentTime=Math.min(els.audio.duration||0,els.audio.currentTime+10));
    }
  }catch(_){}
}
function pause(){ els.audio.pause(); state.playing=false; updateToggle(); }
function updateToggle(){ const btn=$('#toggle'); if(btn) btn.textContent = state.playing ? '⏸️' : '▶️'; }
function jump(dir){ if(!state.filtered.length) return; let i=state.i+dir; if(i<0) i=state.filtered.length-1; if(i>=state.filtered.length) i=0; select(i); play(); }

/* ---- WebAudio Enhance (optional) ---- */
let audioCtx=null, sourceNode=null, hpf=null, presence=null, comp=null, connected=false;
function ensureAudioGraph(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  sourceNode = audioCtx.createMediaElementSource(els.audio);
  hpf = audioCtx.createBiquadFilter(); hpf.type='highpass'; hpf.frequency.value=80; hpf.Q.value=0.707;
  presence = audioCtx.createBiquadFilter(); presence.type='peaking'; presence.frequency.value=1500; presence.Q.value=0.9; presence.gain.value=3;
  comp = audioCtx.createDynamicsCompressor(); comp.threshold.value=-18; comp.knee.value=24; comp.ratio.value=3; comp.attack.value=0.01; comp.release.value=0.2;
}
function connectEnhance(){ if (connected) return; ensureAudioGraph(); sourceNode.connect(hpf).connect(presence).connect(comp).connect(audioCtx.destination); connected=true; }
function disconnectEnhance(){ if (!connected || !audioCtx) return; try{ sourceNode.disconnect(); hpf.disconnect(); presence.disconnect(); comp.disconnect(); sourceNode.connect(audioCtx.destination); }catch(_){} connected=false; }

/* ---- Menu / UI ---- */
function buildMenuUI(){
  const tb = els.toolbar; if (!tb) return;
  tb.innerHTML = '';
  const row = $mk('div'); row.className='row-flex'; tb.appendChild(row);

  // Level 1: About, Playlist, Utilities, Links, Shop, Sort, Search
  const btnAbout = $mk('button',{className:'btn',id:'btnAbout',title:'About',textContent:'📜'});
  const btnFavList = $mk('button',{className:'btn',id:'btnFavList',title:'My playlist (favorites)',textContent:'🎵'});
  const btnUtils = $mk('button',{className:'btn',id:'btnUtils',title:'Utilities',textContent:'🛠️'});
  const btnLinks = $mk('button',{className:'btn',id:'btnLinks',title:'Links',textContent:'🔗'});
  const aShop = $mk('a',{className:'btn',id:'btnShop',title:'Shop',textContent:'🛍️',href:'/shop',target:'_blank',rel:'noopener'});
  const sortSel = $mk('select',{id:'sort',title:'Sort'});
  sortSel.innerHTML = `<option value="date_desc">Newest</option><option value="date_asc">Oldest</option><option value="bpm_desc">BPM ↓</option><option value="bpm_asc">BPM ↑</option><option value="len_desc">Longest</option><option value="len_asc">Shortest</option>`;
  const btnSearch = $mk('button',{className:'btn',id:'btnSearch',title:'Search',textContent:'🔍'});

  row.append(btnAbout, btnFavList, btnUtils, btnLinks, aShop, sortSel, btnSearch);

  // Level 2: Utilities panel (toggles)
  const util = $mk('div'); util.className='panel'; util.id='utilPanel';
  util.innerHTML = `<div class="row-flex">
    <button class="tog" id="togTitles" title="Song Titles (on/off)">📝</button>
    <button class="tog" id="togWav" title="Show WAV buttons">🎚️</button>
    <button class="tog" id="togMov" title="Show MOV buttons">🎬</button>
    <button class="tog" id="togLight" title="Light mode">🌞</button>
    <button class="tog" id="togEnh" title="Enhance (iPhone-friendly EQ)">🎚️+</button>
  </div>`;
  tb.appendChild(util);

  // Level 2: Links panel
  const links = $mk('div'); links.className='panel'; links.id='linksPanel';
  links.innerHTML = `<div class="row-flex">
    <a class="btn" href="https://www.youtube.com/@VVVVIIPP25" target="_blank" rel="noopener" title="YouTube">📺</a>
    <a class="btn" href="https://virtualvip.bandcamp.com/" target="_blank" rel="noopener" title="Bandcamp">🎧</a>
    <a class="btn" href="https://substack.com/home/post/p-170664918?source=queue" target="_blank" rel="noopener" title="Newsletter">📰</a>
    <a class="btn" href="https://www.instagram.com/virtualvip24/" target="_blank" rel="noopener" title="Instagram">📸</a>
  </div>`;
  tb.appendChild(links);

  // Search field
  const searchWrap = $mk('div'); searchWrap.className='search-wrap'; searchWrap.innerHTML = `<input id="searchInput" placeholder="Search… use #tags (e.g. #mbv)" inputmode="search" />`;
  tb.appendChild(searchWrap);
  const searchInput = searchWrap.querySelector('#searchInput');

  // Wire L1
  btnAbout.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); alert("VVIP25 — Vancouver Music and Videography Project 2025"); keepMenuOpen(e); });
  btnFavList.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); state.searchQuery='#favorites'; applyFilterSort(false); keepMenuOpen(e); });
  btnUtils.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); util.style.display = util.style.display==='block' ? 'none' : 'block'; links.style.display='none'; keepMenuOpen(e); });
  btnLinks.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); links.style.display = links.style.display==='block' ? 'none' : 'block'; util.style.display='none'; keepMenuOpen(e); });
  sortSel.addEventListener('change',(e)=>{ applyFilterSort(false,true); keepMenuOpen(e); });

  btnSearch.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation();
    searchWrap.style.display = (searchWrap.style.display==='flex') ? 'none' : 'flex';
    if (searchWrap.style.display==='flex'){ searchInput.value = state.searchQuery; searchInput.focus(); }
    keepMenuOpen(e);
  });
  searchInput.addEventListener('input', debounce(()=>{ state.searchQuery = searchInput.value || ''; applyFilterSort(false,true); }, 150));

  // Wire Utilities toggles
  const btnTitles=util.querySelector('#togTitles');
  const btnWav=util.querySelector('#togWav');
  const btnMov=util.querySelector('#togMov');
  const btnLight=util.querySelector('#togLight');
  const btnEnh=util.querySelector('#togEnh');

  function syncToggles(){
    btnTitles.classList.toggle('on',state.showTitles);
    btnWav.classList.toggle('on',state.showWavButtons);
    btnMov.classList.toggle('on',state.showMovButtons);
    btnLight.classList.toggle('on',state.lightMode);
    btnEnh.classList.toggle('on',connected);
  }
  syncToggles();

  btnTitles.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); state.showTitles=!state.showTitles; syncToggles(); refreshTitles(); keepMenuOpen(e); });
  btnWav.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); state.showWavButtons=!state.showWavButtons; syncToggles(); rerenderVisibleRowsBadges(); if(state.i>=0) updateNowbar(); keepMenuOpen(e); });
  btnMov.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); state.showMovButtons=!state.showMovButtons; syncToggles(); rerenderVisibleRowsBadges(); if(state.i>=0) updateNowbar(); keepMenuOpen(e); });
  btnLight.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); state.lightMode=!state.lightMode; document.body.classList.toggle('light',state.lightMode); localStorage.setItem('vvip25:light', state.lightMode?'1':'0'); syncToggles(); keepMenuOpen(e); });
  btnEnh.addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); if(!connected) connectEnhance(); else disconnectEnhance(); syncToggles(); keepMenuOpen(e); });

  // Keep overlay open only when interacting with it
  tb.addEventListener('click', keepMenuOpen);
}

function keepMenuOpen(e){ const m=els.menu; if(!m) return; if(e){e.preventDefault?.(); e.stopPropagation?.();} m.open=true; }

/* ---- Events (row click, favorites, player) ---- */
document.addEventListener('click',(e)=>{
  // Favorites toggle (lights on/off)
  const favBtn=e.target.closest?.('.star');
  if (favBtn && favBtn.hasAttribute('data-fav')){
    const key=favBtn.getAttribute('data-fav'); const was=state.favorites.has(key);
    if (was){ state.favorites.delete(key); state.favOrder=state.favOrder.filter(n=>n!==key); }
    else { state.favorites.add(key); if(!state.favOrder.includes(key)) state.favOrder.push(key); }
    localStorage.setItem('vvip25:favs', JSON.stringify(Array.from(state.favorites)));
    localStorage.setItem('vvip25:favOrder', JSON.stringify(state.favOrder));
    favBtn.classList.toggle('on', !was);
    e.preventDefault(); e.stopPropagation(); return;
  }
  // Row select (do NOT open menu)
  const row=e.target.closest?.('.row');
  if(row && !e.target.closest('a')){
    const id=Number(row.getAttribute('data-id')); const idx=state.filtered.findIndex(t=>t.id===id);
    if(idx>=0){ select(idx); play(); }
  }
},{ passive:false });

$('#toggle')?.addEventListener('click', ()=>{ if (state.i<0 && state.filtered.length) select(0); state.playing?pause():play(); }, { passive:true });
els.prev?.addEventListener('click', ()=> jump(-1), { passive:true });
els.next?.addEventListener('click', ()=> jump(1), { passive:true });

els.audio.addEventListener('timeupdate', ()=>{
  const a=els.audio; if(!isFinite(a.duration)) return;
  els.seek.max=Math.floor(a.duration); els.seek.value=Math.floor(a.currentTime);
  $('#tcur').textContent = fmtDur(a.currentTime);
  $('#tdur').textContent = isFinite(a.duration) ? fmtDur(a.duration) : '0:00';
});
els.seek.addEventListener('input', ()=>{ els.audio.currentTime=Number(els.seek.value); });
els.vol.addEventListener('input', ()=>{ els.audio.volume=parseFloat(els.vol.value); localStorage.setItem('vvip25:vol', els.vol.value); });
els.audio.addEventListener('ended', ()=> jump(1));
</script>
</body>
</html>