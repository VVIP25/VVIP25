<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VVIP25</title>
  <link rel="icon" type="image/png" sizes="64x64" href="/favicon-64.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" href="/favicon.ico?v=3">
  <meta name="theme-color" content="#0b0b0c" />
  <style>
    :root{--bg:#0b0b0c;--fg:#eceff4;--muted:#9aa0a6;--card:#141416;--border:#26272b;--accent:#6ee7b7}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,"Segoe UI",Roboto,Inter,system-ui,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:16px}

    header{display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative}
    #site-title{margin:0;font-size:56px;font-weight:bold;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;color:transparent;-webkit-text-fill-color:transparent;-webkit-text-stroke:2px #fdf6d0}

    .player{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,11,12,.97),rgba(11,11,12,.92));backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--border)}
    .now{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:12px 0}
    .cover{width:56px;height:56px;border-radius:8px;background:#1e1f24;display:grid;place-items:center;color:var(--muted);font-weight:700;border:1px solid var(--border)}
    .meta{min-width:0}
    .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .controls{display:flex;align-items:center;gap:8px}
    button{appearance:none;background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .range{display:flex;align-items:center;gap:8px}
    input[type="range"]{width:160px}
    .list{margin:12px 0 40px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .row{display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center;padding:10px 12px;border-top:1px solid var(--border);background:var(--card);min-height:78px}
    .row:first-child{border-top:0}
    .row:hover{background:#17171b}
    .badge{display:flex;gap:10px;align-items:center;font-size:12px;justify-self:end}
    .badge a{color:var(--fg);text-decoration:none;border:1px solid var(--border);padding:4px 8px;border-radius:8px}
    .badge .muted{color:var(--muted)}
    .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas;background:#1b1c20;border:1px solid #2a2b30;border-radius:6px;padding:2px 6px;color:#d7dae0}

    /* Toolbar + toggles */
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .tog,.btn{
      display:inline-flex;align-items:center;justify-content:center;
      height:36px;min-width:36px;padding:0 10px;
      border-radius:10px;border:1px solid var(--border);background:var(--card);
      text-decoration:none;color:var(--fg);line-height:1
    }
    .tog{opacity:.6;transition:opacity .15s, box-shadow .15s}
    .tog.on{opacity:1;box-shadow:0 0 0 2px var(--accent) inset}

    /* Hamburger (overlay) */
    details.menu{position:static}
    details.menu>summary{cursor:pointer;list-style:none;background:var(--card);border:1px solid var(--border);padding:8px 12px;border-radius:10px;user-select:none}
    .sheet{position:absolute;top:calc(100% + 8px);right:0;z-index:20;width:min(420px,calc(100vw - 32px));background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;display:none;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    details.menu[open]>.sheet{display:block}
    details.menu[open]>summary{border-bottom-left-radius:10px;border-bottom-right-radius:10px}

    /* Hide the volume control on iOS Safari */
    @supports (-webkit-touch-callout:none){.range[title="Volume"]{display:none !important}}

    @media (max-width:560px){
      .now{grid-template-columns:1fr;gap:8px}
      .cover{display:none}
      .controls{flex-wrap:wrap}
      .range input[type="range"]{width:120px}
      .row{grid-template-columns:1fr auto}
    }
  </style>
</head>
<body>
  <div class="player">
    <div class="wrap">
      <header>
        <h1 id="site-title">VVIP25</h1>
        <details class="menu" id="menu">
          <summary>‚ò∞ Menu</summary>
          <div class="sheet">
            <div class="toolbar" id="toolbar">
              <select id="sort" title="Sort">
                <option value="date_desc">Newest</option>
                <option value="date_asc">Oldest</option>
                <option value="bpm_desc">BPM ‚Üì</option>
                <option value="bpm_asc">BPM ‚Üë</option>
                <option value="len_desc">Longest</option>
                <option value="len_asc">Shortest</option>
              </select>
              <button class="tog on" id="togTitles" title="Song Titles (on/off)">üìù</button>
              <button class="tog" id="togWav" title="Show WAV buttons">üéöÔ∏è</button>
              <button class="tog" id="togMov" title="Show MOV buttons">üé¨</button>
              <button class="btn" id="btnAbout" title="About">‚ÑπÔ∏è</button>
              <a class="btn" id="btnShop" href="/shop" target="_blank" rel="noopener" title="Shop">üõçÔ∏è</a>
            </div>
          </div>
        </details>
      </header>

      <div class="now">
        <div class="cover" id="cover">V25</div>
        <div class="meta">
          <div class="title" id="now-title">‚Äî</div>
          <div class="sub" id="now-sub">Ready</div>
        </div>
        <div class="controls">
          <button id="prev" aria-label="Previous">‚èÆÔ∏è</button>
          <button id="toggle" aria-label="Play/Pause">‚ñ∂Ô∏è</button>
          <button id="next" aria-label="Next">‚è≠Ô∏è</button>
          <div class="range">
            <span id="tcur">0:00</span>
            <input id="seek" type="range" min="0" max="100" value="0" step="1" aria-label="Seek" />
            <span id="tdur">0:00</span>
          </div>
          <div class="range" title="Volume">
            <span>üîä</span>
            <input id="vol" type="range" min="0" max="1" step="0.01" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="list" class="list" role="list"></div>
  </div>

  <audio id="audio" preload="metadata"></audio>

<script>
/* ===== VVIP25 ‚Äî pared-back, ES5-safe build =====
   - Robust init (no optional chaining; DOM ready guard)
   - Clean menu: About ‚Ä¢ Playlist ‚Ä¢ Utilities ‚Ä¢ Links ‚Ä¢ Shop
   - Utilities: Titles / WAV buttons / MOV buttons
   - Favourites star lights when active
   - Titles ON hides ‚Äúnameless‚Äù (date-only) tracks
   - Safe fetch with cache-busting + no-store
   - Basic error/rejection traps to surface console errors
*/

(function(){
  // ---------- Error traps ----------
  window.addEventListener('error', function(e){ try{ console.log('JS error:', e.message); }catch(_){ } });
  window.addEventListener('unhandledrejection', function(e){ try{ console.log('Promise rejection:', e.reason); }catch(_){ } });

  // ---------- Config ----------
  var ASSET_VERSION = 11; // bump this when you change JSON/JS
  var BASE_MP3   = 'https://media.vvipmedia.net/ACCESS/';
  var BASE_WAV   = 'https://media.vvipmedia.net/WAV/';
  var BASE_THUMB = 'https://media.vvipmedia.net/ACCESS/';
  var BASE_VIDEO = 'https://media.vvipmedia.net/VIDEOS/';
  var DEFAULT_THUMB = BASE_THUMB + 'default_thumb.jpg';

  // Add a light cache hint
  try{
    var m=document.createElement('meta');
    m.httpEquiv='Cache-Control';
    m.content='no-store, max-age=0, must-revalidate';
    document.head.appendChild(m);
  }catch(_){}

  // ---------- Tiny CSS patch for controls + submenu ----------
  (function(){
    var css = '' +
      '.controls{flex-wrap:wrap;gap:10px}' +
      '.controls .range{min-width:140px;flex:1}' +
      '.controls .range input[type=range]{width:100%}' +
      '.controls button{min-width:44px}' +
      '.btn,.tog{display:inline-flex;align-items:center;justify-content:center;height:36px;min-width:36px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--fg);text-decoration:none;line-height:1;cursor:pointer}' +
      '.tog{opacity:.7;transition:opacity .15s, box-shadow .15s}' +
      '.tog.on{opacity:1;box-shadow:0 0 0 2px var(--accent) inset}' +
      '.util-panel,.links-panel,.search-wrap{display:none;margin-top:8px;border:1px solid var(--border);border-radius:10px;padding:8px}' +
      '.util-row,.links-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}' +
      '.search-wrap input{flex:1;min-width:140px;background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 10px}' +
      '.pill{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;text-decoration:none;color:var(--fg)}' +
      '.star{cursor:pointer}' +
      '.star.on{filter:drop-shadow(0 0 2px var(--accent)) brightness(1.2)}' +
      '@media (max-width:560px){.controls{gap:6px}.controls button{flex:0 0 44px}.range span{min-width:34px;text-align:center}}';
    var style=document.createElement('style'); style.textContent=css; document.head.appendChild(style);
  })();

  // ---------- Helpers ----------
  function $(sel){ return document.querySelector(sel); }
  function fmtDur(sec){ sec=Number(sec||0); var m=Math.floor(sec/60), s=Math.floor(sec%60); return m+':' + (s<10?'0'+s:s); }
  function debounce(fn,ms){ var t; return function(){ var a=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(null,a); },ms); }; }
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'})[c]; }); }
  function removeBpm(str){ if(!str) return str; return String(str).replace(/\b\d+(?:\.\d+)?(?:\s*[‚Äì‚Äî-]\s*\d+(?:\.\d+)?)?\s*BPM\b/gi,'').replace(/\s{2,}/g,' ').trim(); }
  function cleanToken(s){ if(!s) return ''; s=String(s).trim().replace(/^[¬∑‚Ä¢,;:\-]+|[¬∑‚Ä¢,;:\-]+$/g,'').replace(/\s*[.,;:]\s*$/,''); return s.trim(); }
  function uniqJoin(parts){
    var seen={}, out=[], i, raw, key;
    for(i=0;i<parts.length;i++){
      raw = parts[i]; if(raw==null) continue;
      raw = cleanToken(removeBpm(raw)); if(!raw) continue;
      key = raw.toLowerCase(); if(seen[key]) continue; seen[key]=1; out.push(raw);
    }
    return out.join(' ¬∑ ');
  }
  function rawFile(s){ s=String(s); var bits=s.split('/'); return bits[bits.length-1]||''; }
  function stripExt(s){ return String(s).replace(/\.[a-z0-9]+$/i,''); }
  function softNorm(s){ return stripExt(s).toLowerCase().replace(/[ _]+/g,'-').replace(/-+/g,'-'); }
  function deriveTitleFromFilename(name){
    var b=stripExt(rawFile(name)).replace(/^[\d._-]+/,'').replace(/[_-]+/g,' ').trim();
    return b || stripExt(rawFile(name));
  }
  function primaryOnly(t){ return String(t||'').split('//')[0].trim(); }

  var DATE_RX_YYYY=/^\s*(\d{4})[.\-_](\d{2})[.\-_](\d{2})(?=\D|$)/;
  var DATE_RX_YY=/^\s*(\d{2})[.\-_](\d{2})[.\-_](\d{2})(?=\D|$)/;
  var WITHIN_DAY_RX=/^\s*(?:\d{4}|\d{2})[.\-_]\d{2}[.\-_]\d{2}(?:[.\-_](\d+))?/;
  function fallbackDateFromName(name){
    var s=String(name), m=s.match(DATE_RX_YYYY);
    if(m){ var yyyy=Math.max(1970,Math.min(2100,parseInt(m[1],10)));
      var mm=Math.max(1,Math.min(12,parseInt(m[2],10)));
      var dd=Math.max(1,Math.min(31,parseInt(m[3],10)));
      return new Date(Date.UTC(yyyy,mm-1,dd));
    }
    m=s.match(DATE_RX_YY);
    if(m){ var yy=parseInt(m[1],10); var yyyy2=(yy>=70?1900+yy:2000+yy);
      var mm2=Math.max(1,Math.min(12,parseInt(m[2],10)));
      var dd2=Math.max(1,Math.min(31,parseInt(m[3],10)));
      return new Date(Date.UTC(yyyy2,mm2-1,dd2));
    }
    return null;
  }
  function withinDayIndexFromName(name){ var m=String(name).match(WITHIN_DAY_RX); return (m && m[1])?parseInt(m[1],10):0; }
  function bpmSortValue(t){ if(t.bpm!=null) return t.bpm; if(t.bpm_min!=null&&t.bpm_max!=null) return (t.bpm_min+t.bpm_max)/2; return 0; }
  function bpmLabel(t){ if(t.bpm!=null) return t.bpm+' BPM'; if(t.bpm_min!=null&&t.bpm_max!=null) return t.bpm_min+'‚Äì'+t.bpm_max+' BPM'; return ''; }

  // ---------- Elements ----------
  var els = {
    audio: $('#audio'),
    list: $('#list'),
    sort: $('#sort'),
    toggle: $('#toggle'),
    prev: $('#prev'),
    next: $('#next'),
    seek: $('#seek'),
    vol: $('#vol'),
    nowTitle: $('#now-title'),
    nowSub: $('#now-sub'),
    tcur: $('#tcur'),
    tdur: $('#tdur'),
    cover: $('#cover'),
    menu: $('#menu'),
    toolbar: $('#toolbar')
  };

  // ---------- State ----------
  var state = {
    tracks: [],
    filtered: [],
    i: -1,
    playing: false,
    pageSize: 60,
    renderCount: 0,
    titlesLookup: {},
    thumbBases: {},
    resolvedThumb: {},
    showTitles: false,       // Titles toggle OFF by default
    showWavButtons: false,
    showMovButtons: false,
    favorites: (function(){ try{ return new Set(JSON.parse(localStorage.getItem('vvip25:favs')||'[]')); }catch(_){ return new Set(); } })(),
    favOrder: (function(){ try{ return JSON.parse(localStorage.getItem('vvip25:favOrder')||'[]'); }catch(_){ return []; } })(),
    searchQuery: ''
  };

  // Persisted volume
  try{
    var volStr = localStorage.getItem('vvip25:vol');
    els.vol.value = volStr!=null ? volStr : '0.9';
    els.audio.volume = parseFloat(els.vol.value);
  }catch(_){}

  // ---------- Init ----------
  function init(){
    buildMenuUI();
    fetchAndBuild();
    wirePlayer();
  }

  function fetchAndBuild(){
    var url = './manifest.json?v=' + ASSET_VERSION;
    fetch(url, { cache:'no-store' })
      .then(function(r){ if(!r.ok) throw new Error('manifest fetch '+r.status); return r.json(); })
      .then(function(data){
        state.tracks = data.map(function(t,idx){
          var name = t.name || t.file || (t.src? rawFile(t.src):('track-'+idx+'.mp3'));
          var base = stripExt(name), baseLower = base.toLowerCase();
          var dateObj = t.date ? new Date(t.date) : fallbackDateFromName(name);
          var labelDate = dateObj ? dateObj.toISOString().slice(0,10) : '';
          var mp3 = t.src || (BASE_MP3 + encodeURIComponent(name));
          var wav = BASE_WAV + encodeURIComponent(base + '.wav');
          var mov = t.has_mov ? (BASE_VIDEO + encodeURIComponent(base + '.mov')) : null;
          var notes = '';
          if (t.notes && Object.prototype.toString.call(t.notes)==='[object Array]') notes = t.notes.join(' ');
          else if (typeof t.notes==='string') notes = t.notes;

          return {
            id: idx,
            name: name,
            base: base,
            baseLower: baseLower,
            title: t.title ? String(t.title) : '',
            bpm: t.bpm!=null?t.bpm:null,
            bpm_min: t.bpm_min!=null?t.bpm_min:null,
            bpm_max: t.bpm_max!=null?t.bpm_max:null,
            details: t.details || '',
            length: t.length || 0,
            date: dateObj || null,
            labelDate: labelDate,
            src: mp3,
            wav: wav,
            video: mov,
            thumbCandidate: BASE_THUMB + encodeURIComponent(baseLower + 'thumb.jpg'),
            notes: notes || ''
          };
        });

        applyFilterSort(true);
        computeThumbCascade();
        renderList();
        fillViewport();
        if (state.filtered.length && state.i === -1) { select(0); }

        // Titles + thumbs (lazy)
        setTimeout(fetchTitles, 0);
        setTimeout(fetchThumbs, 50);
      })
      .catch(function(err){
        console.log('manifest error:', err && err.message ? err.message : err);
        els.list.innerHTML = '<div class="row"><div></div><div>manifest.json not found or blocked.</div></div>';
      });
  }

  // ---------- Titles ----------
  function buildTitleLookup(json){
    var map = {};
    function add(k, titleRaw){
      if(!k || !titleRaw) return;
      var title = primaryOnly(titleRaw);
      var rawLower = String(k).toLowerCase();
      var justFile = rawFile(rawLower);
      var noExt = stripExt(justFile);
      var norm = softNorm(justFile);
      map[justFile] = String(title);
      map[noExt]   = String(title);
      map[norm]    = String(title);
    }
    if (Object.prototype.toString.call(json)==='[object Array]'){
      for (var i=0;i<json.length;i++){
        var row=json[i]; if(!row) continue;
        add(row.key||row.src||row.name, row.title||row.t||row.display);
      }
    } else if (json && typeof json==='object'){
      for (var k in json){
        if (!json.hasOwnProperty(k)) continue;
        var v=json[k];
        add(k, (typeof v==='string')?v:(v && typeof v.title==='string'?v.title:''));
      }
    }
    return map;
  }
  function bestTitleForTrack(t,lookup){
    var f=rawFile(t.name).toLowerCase(), noExt=stripExt(f), norm=softNorm(f), fromSrc=t.src?rawFile(t.src).toLowerCase():'';
    var candidates=[f,noExt,norm,fromSrc,stripExt(fromSrc),softNorm(fromSrc), (t.base||'').toLowerCase(), softNorm(t.base||'')];
    for (var i=0;i<candidates.length;i++){ var c=candidates[i]; if (c && lookup[c]) return lookup[c]; }
    return '';
  }
  function fetchTitles(){
    fetch('./titles.json?v='+ASSET_VERSION, {cache:'no-store'})
      .then(function(r){ if(!r.ok) throw 0; return r.json(); })
      .then(function(json){
        var lookup = buildTitleLookup(json);
        state.titlesLookup = lookup;
        var changed=false;
        for (var i=0;i<state.tracks.length;i++){
          var t=state.tracks[i];
          var fromTitles=bestTitleForTrack(t,lookup);
          var finalTitle= fromTitles || t.title || deriveTitleFromFilename(t.name);
          if (finalTitle !== t.title){ t.title=finalTitle; changed=true; }
        }
        if (changed){ applyFilterSort(false,true); refreshTitles(); }
      })
      .catch(function(){ /* ignore */ });
  }

  // ---------- Thumbs ----------
  function fetchThumbs(){
    fetch('./thumbs.json?v='+ASSET_VERSION, {cache:'no-store'})
      .then(function(r){ if(!r.ok) throw 0; return r.json(); })
      .then(function(data){
        var set = {};
        if (Object.prototype.toString.call(data)==='[object Array]'){
          for (var i=0;i<data.length;i++){ set[String(data[i]).toLowerCase()] = true; }
        } else if (data && typeof data==='object'){
          for (var k in data){ if (data.hasOwnProperty(k) && data[k]) set[k.toLowerCase()]=true; }
        }
        state.thumbBases = set;
        computeThumbCascade();
        rerenderVisibleRowsThumbs();
        if (state.i>=0) updateNowbar();
      })
      .catch(function(){ /* ignore */ });
  }
  function computeThumbCascade(){
    var asc = state.tracks.slice().sort(function(a,b){
      var da=a.date? a.date.getTime():0, db=b.date? b.date.getTime():0;
      if (da!==db) return da-db;
      var wa=withinDayIndexFromName(a.name), wb=withinDayIndexFromName(b.name);
      if (wa!==wb) return wa-wb;
      return a.name.localeCompare(b.name);
    });
    var currentThumb = DEFAULT_THUMB;
    for (var i=0;i<asc.length;i++){
      var t=asc[i];
      if (state.thumbBases[t.baseLower]) currentThumb = t.thumbCandidate;
      state.resolvedThumb[t.id] = currentThumb;
    }
  }
  function getResolvedThumb(t){ return state.resolvedThumb[t.id] || DEFAULT_THUMB; }

  // ---------- Filter / sort ----------
  function isNameless(t){
    var derived=deriveTitleFromFilename(t.name);
    return (!t.title || t.title===derived);
  }
  function matchesTokens(t, tokens){
    if (!tokens.length) return true;
    var hayName=(t.name||'').toLowerCase();
    var hayTitle=(t.title||'').toLowerCase();
    var hayNotes=(t.notes||'').toLowerCase();
    for (var i=0;i<tokens.length;i++){
      var tok=tokens[i];
      if (!tok) continue;
      if (tok.charAt(0)==='#'){
        if (hayNotes.indexOf(tok)===-1) return false;
      } else {
        if (hayName.indexOf(tok)===-1 && hayTitle.indexOf(tok)===-1 && hayNotes.indexOf(tok)===-1) return false;
      }
    }
    return true;
  }

  function applyFilterSort(firstPaint, keepIndex){
    if (firstPaint==null) firstPaint=false;
    if (keepIndex==null) keepIndex=false;

    var q=(state.searchQuery||'').trim().toLowerCase();
    var tokens = q ? q.split(/\s+/) : [];

    var out = state.tracks.slice(0);

    // favourites preset
    var favoritesOnly = false;
    for (var i=0;i<tokens.length;i++){ if (tokens[i]==='#favorites'){ favoritesOnly=true; break; } }
    if (favoritesOnly){
      out = out.filter(function(t){ return state.favorites.has(t.name); });
    }

    // Titles-on hides nameless
    if (state.showTitles){
      out = out.filter(function(t){ return !isNameless(t); });
    }

    // Remaining tokens (exclude #favorites)
    var tokens2=[];
    for (var j=0;j<tokens.length;j++){ if (tokens[j]!=='#favorites') tokens2.push(tokens[j]); }
    out = out.filter(function(t){ return matchesTokens(t, tokens2); });

    // Order
    if (favoritesOnly){
      var orderIndex={}, k;
      for (k=0;k<state.favOrder.length;k++){ orderIndex[state.favOrder[k]]=k; }
      out.sort(function(a,b){
        var ia = (orderIndex[a.name]!=null)?orderIndex[a.name]:1e9;
        var ib = (orderIndex[b.name]!=null)?orderIndex[b.name]:1e9;
        return ia-ib;
      });
    } else {
      var sortVal = els.sort && els.sort.value ? els.sort.value : 'date_desc';
      if (sortVal==='date_desc'){
        out.sort(function(a,b){
          var da=b.date? b.date.getTime():0, db=a.date? a.date.getTime():0;
          if (da!==db) return da-db;
          var wa=withinDayIndexFromName(b.name), wb=withinDayIndexFromName(a.name);
          if (wa!==wb) return wa-wb;
          return b.name.localeCompare(a.name);
        });
      } else if (sortVal==='date_asc'){
        out.sort(function(a,b){
          var da=a.date? a.date.getTime():0, db=b.date? b.date.getTime():0;
          if (da!==db) return da-db;
          var wa=withinDayIndexFromName(a.name), wb=withinDayIndexFromName(b.name);
          if (wa!==wb) return wa-wb;
          return a.name.localeCompare(b.name);
        });
      } else if (sortVal==='bpm_desc'){
        out.sort(function(a,b){ return bpmSortValue(b)-bpmSortValue(a); });
      } else if (sortVal==='bpm_asc'){
        out.sort(function(a,b){ return bpmSortValue(a)-bpmSortValue(b); });
      } else if (sortVal==='len_desc'){
        out.sort(function(a,b){ return (b.length||0)-(a.length||0); });
      } else if (sortVal==='len_asc'){
        out.sort(function(a,b){ return (a.length||0)-(b.length||0); });
      }
    }

    state.filtered = out;
    var initialChunk = firstPaint ? Math.max(60, state.pageSize) : state.pageSize;
    state.renderCount = Math.min(state.filtered.length, initialChunk);

    if (!keepIndex) state.i = Math.min(state.i, state.renderCount-1);
    renderList();
    setupInfiniteScroll();
    fillViewport();
  }

  function displayName(t){ return (state.showTitles && t.title) ? t.title : t.name; }

  // ---------- Render ----------
  function imgHTML(src){
    var esc = String(src).replace(/"/g,'&quot;');
    return '<img src="'+esc+'" alt="" loading="lazy" style="width:56px;height:56px;object-fit:cover;border-radius:8px;" onerror="if(this.dataset.fbk!==\'1\'){this.dataset.fbk=\'1\';this.onerror=null;this.src=\''+DEFAULT_THUMB+'\';}">';
  }
  function favHTML(t){
    var on = state.favorites.has(t.name) ? ' on' : '';
    var title = state.favorites.has(t.name) ? 'Remove from favorites' : 'Add to favorites';
    return '<button class="star'+on+'" data-fav="'+escapeHTML(t.name)+'" title="'+title+'">‚òÖ</button>';
  }
  function badgeHTML(t){
    var parts = [ favHTML(t), '<a class="pill" href="'+t.src+'" download title="Download MP3">MP3</a>' ];
    if (state.showWavButtons){ parts.push('<a class="pill" href="'+(BASE_WAV+encodeURIComponent(t.base+'.wav'))+'" download title="Download Lossless">WAV</a>'); }
    if (state.showMovButtons && t.video){ parts.push('<a class="pill" href="'+t.video+'" target="_blank" rel="noopener" title="Open Video">MOV</a>'); }
    if (state.showMovButtons && !t.video){ parts.push('<span class="pill" style="opacity:.6">MOV</span>'); }
    return '<div class="badge">'+parts.join(' ')+'</div>';
  }
  function rowHTML(t, active){
    var bpmTxt=bpmLabel(t), thumbURL=getResolvedThumb(t);
    var subline=uniqJoin([ state.showTitles? '' : (t.title||''), bpmTxt, t.length?fmtDur(t.length):'', t.details||'', t.notes||'' ]);
    var hasTitleClass=(t.title && !isNameless(t)) ? ' has-title':'';
    return '<div class="row'+hasTitleClass+'" role="listitem" data-id="'+t.id+'">' +
             '<div class="cover" aria-hidden="true">'+imgHTML(thumbURL)+'</div>' +
             '<div><div class="title">'+(active?'‚ñ∂Ô∏é ':'')+escapeHTML(displayName(t))+'</div>' +
             '<div class="sub">'+escapeHTML(subline)+'</div></div>' +
             badgeHTML(t) +
           '</div>';
  }
  function renderList(){
    if(!state.filtered.length){
      els.list.innerHTML = '<div class="row"><div></div><div>No results.</div></div>';
      return;
    }
    var html='', i, t, active;
    for (i=0;i<state.renderCount;i++){
      t = state.filtered[i];
      active = (state.i>=0 && state.filtered[state.i] && state.filtered[state.i].id===t.id);
      html += rowHTML(t, active);
    }
    html += '<div id="sentinel" style="height:1px"></div>';
    els.list.innerHTML = html;
  }
  function rerenderVisibleRowsThumbs(){
    var rows = els.list.querySelectorAll('.row');
    for (var i=0;i<rows.length;i++){
      var id = parseInt(rows[i].getAttribute('data-id'),10);
      var t = null, j;
      for (j=0;j<state.tracks.length;j++){ if (state.tracks[j].id===id){ t=state.tracks[j]; break; } }
      if (!t) continue;
      var img = rows[i].querySelector('.cover img');
      if (img) img.src = getResolvedThumb(t);
    }
  }
  function rerenderVisibleRowsBadges(){
    var rows = els.list.querySelectorAll('.row');
    for (var i=0;i<rows.length;i++){
      var id = parseInt(rows[i].getAttribute('data-id'),10);
      var t=null, j; for (j=0;j<state.tracks.length;j++){ if(state.tracks[j].id===id){ t=state.tracks[j]; break; } }
      if (!t) continue;
      var badge = rows[i].querySelector('.badge');
      if (badge){ badge.outerHTML = badgeHTML(t); }
    }
  }
  function refreshTitles(){
    var rows = document.querySelectorAll('.row');
    for (var i=0;i<rows.length;i++){
      var id = parseInt(rows[i].getAttribute('data-id'),10);
      var t=null, j; for (j=0;j<state.tracks.length;j++){ if (state.tracks[j].id===id){ t=state.tracks[j]; break; } }
      if (!t) continue;
      var titleEl = rows[i].querySelector('.title');
      var subEl   = rows[i].querySelector('.sub');
      if (titleEl){
        var isActive = (state.i>=0 && state.filtered[state.i] && state.filtered[state.i].id===id);
        titleEl.innerHTML = (isActive?'‚ñ∂Ô∏é ':'') + escapeHTML(displayName(t));
      }
      if (subEl){
        var bpmTxt=bpmLabel(t);
        var subline=uniqJoin([ state.showTitles? '' : (t.title||''), bpmTxt, t.length?fmtDur(t.length):'', t.details||'', t.notes||'' ]);
        subEl.textContent=subline;
      }
      if ((t.title && !isNameless(t))) rows[i].classList.add('has-title'); else rows[i].classList.remove('has-title');
    }
    if (state.i>=0) updateNowbar();
    applyFilterSort(false,true);
  }

  // ---------- Infinite scroll ----------
  var sentinelObserver = null;
  function setupInfiniteScroll(){
    var s = $('#sentinel'); if(!s) return;
    if (sentinelObserver && sentinelObserver.disconnect) sentinelObserver.disconnect();
    if ('IntersectionObserver' in window){
      sentinelObserver = new IntersectionObserver(function(entries){
        for (var i=0;i<entries.length;i++){ if (entries[i].isIntersecting) appendChunk(); }
      }, { root:null, rootMargin:'1200px 0px', threshold:0 });
      sentinelObserver.observe(s);
    }
    window.addEventListener('scroll', onScrollMaybeLoad, { passive:true });
    window.addEventListener('resize', debounce(fillViewport,120), { passive:true });
  }
  function appendChunk(){
    if (state.renderCount>=state.filtered.length) return;
    var prev=state.renderCount;
    state.renderCount = Math.min(state.filtered.length, state.renderCount + state.pageSize);
    var sentinel = $('#sentinel'); if (!sentinel) return;
    var frag = document.createDocumentFragment();
    for (var i=prev;i<state.renderCount;i++){
      var t = state.filtered[i];
      var div = document.createElement('div');
      div.innerHTML = rowHTML(t, (state.i>=0 && state.filtered[state.i] && state.filtered[state.i].id===t.id));
      frag.appendChild(div.firstChild);
    }
    els.list.insertBefore(frag, sentinel);
  }
  function atBottomBuffer(px){ if(px==null) px=1200; return (window.scrollY + window.innerHeight + px) >= document.documentElement.scrollHeight; }
  function onScrollMaybeLoad(){ if (atBottomBuffer(1200)) appendChunk(); }
  function fillViewport(){
    var guard=0;
    while (guard++<10){
      var scrollable = document.documentElement.scrollHeight > window.innerHeight + 200;
      if (scrollable || state.renderCount>=state.filtered.length) break;
      appendChunk();
    }
  }

  // ---------- Selection / Player ----------
  function select(indexInFiltered){
    state.i = indexInFiltered;
    var t = state.filtered[indexInFiltered]; if(!t) return;
    els.audio.src = t.src;
    updateNowbar();
    state.playing = false; updateToggle();

    var rendered = els.list.querySelectorAll('.row');
    for (var i=0;i<rendered.length;i++){
      var id = parseInt(rendered[i].getAttribute('data-id'),10);
      var isActive = (state.filtered[state.i] && state.filtered[state.i].id===id);
      var titleEl = rendered[i].querySelector('.title');
      if (titleEl){
        var target=null, j; for (j=0;j<state.tracks.length;j++){ if(state.tracks[j].id===id){ target=state.tracks[j]; break; } }
        if (!target) target=t;
        titleEl.innerHTML = (isActive?'‚ñ∂Ô∏é ':'') + escapeHTML(displayName(target));
      }
      var favBtn = rendered[i].querySelector('.star[data-fav]');
      if (favBtn){
        var key = favBtn.getAttribute('data-fav');
        favBtn.classList.toggle('on', state.favorites.has(key));
      }
    }
  }
  function updateNowbar(){
    var t = state.filtered[state.i]; if(!t) return;
    els.nowTitle.textContent = displayName(t);
    var bpmTxt = bpmLabel(t);
    els.nowSub.textContent = uniqJoin([ state.showTitles? '' : (t.title||''), bpmTxt, t.length?fmtDur(t.length):'', t.details||'', t.notes||'' ]);
    var url = getResolvedThumb(t);
    els.cover.innerHTML = '<img src="'+url.replace(/"/g,'&quot;')+'" alt="" style="width:56px;height:56px;border-radius:8px;object-fit:cover;" onerror="if(this.dataset.fbk!==\'1\'){this.dataset.fbk=\'1\';this.onerror=null;this.src=\''+DEFAULT_THUMB+'\';}">';
  }
  function play(){
    els.audio.play().then(function(){
      state.playing=true; updateToggle();
      if('mediaSession' in navigator && window.MediaMetadata){
        var t=state.filtered[state.i];
        try{
          navigator.mediaSession.metadata = new MediaMetadata({ title: displayName(t) });
          navigator.mediaSession.setActionHandler('previoustrack', function(){ jump(-1); });
          navigator.mediaSession.setActionHandler('nexttrack', function(){ jump(1); });
          navigator.mediaSession.setActionHandler('seekbackward', function(){ els.audio.currentTime=Math.max(0, els.audio.currentTime-10); });
          navigator.mediaSession.setActionHandler('seekforward',  function(){ els.audio.currentTime=Math.min(els.audio.duration||0, els.audio.currentTime+10); });
        }catch(_){}
      }
    }).catch(function(){ /* autoplay blocked */ });
  }
  function pause(){ els.audio.pause(); state.playing=false; updateToggle(); }
  function updateToggle(){ var btn = document.querySelector('#toggle'); if (btn) btn.textContent = state.playing ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'; }
  function jump(dir){
    if(!state.filtered.length) return;
    var i = state.i + dir;
    if (i<0) i = state.filtered.length-1;
    if (i>=state.filtered.length) i = 0;
    select(i); play();
  }

  // ---------- Menu (About ‚Ä¢ Playlist ‚Ä¢ Utilities ‚Ä¢ Links ‚Ä¢ Shop) ----------
  function buildMenuUI(){
    var tb = els.toolbar; if(!tb) return;
    tb.innerHTML = '';
    var row = document.createElement('div');
    row.style.display='flex'; row.style.gap='8px'; row.style.flexWrap='wrap'; row.style.alignItems='center';
    tb.appendChild(row);

    // About (modal)
    var btnAbout = document.createElement('button'); btnAbout.className='btn'; btnAbout.id='btnAbout'; btnAbout.title='About'; btnAbout.textContent='üìú';
    row.appendChild(btnAbout);
    btnAbout.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); alert('VVIP25 ‚Äî Vancouver Music and Videography Project 2025'); keepMenuOpen(e); });

    // Playlist (favorites)
    var btnFavList = document.createElement('button'); btnFavList.className='btn'; btnFavList.id='btnFavList'; btnFavList.title='My favorites playlist'; btnFavList.textContent='üéµ';
    row.appendChild(btnFavList);
    btnFavList.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); state.searchQuery='#favorites'; applyFilterSort(false); keepMenuOpen(e); });

    // Utilities (toggles)
    var btnUtils=document.createElement('button'); btnUtils.className='btn'; btnUtils.id='btnUtils'; btnUtils.title='Utilities'; btnUtils.textContent='üõ†Ô∏è'; row.appendChild(btnUtils);

    // Links
    var btnLinks=document.createElement('button'); btnLinks.className='btn'; btnLinks.id='btnLinks'; btnLinks.title='Links'; btnLinks.textContent='üîó'; row.appendChild(btnLinks);

    // Shop
    var aShop=document.createElement('a'); aShop.className='btn'; aShop.id='btnShop'; aShop.title='Shop'; aShop.textContent='üõçÔ∏è'; aShop.href='/shop'; aShop.target='_blank'; aShop.rel='noopener';
    row.appendChild(aShop);

    // Sort select
    var sortSel=document.createElement('select'); sortSel.id='sort'; sortSel.title='Sort';
    sortSel.innerHTML='<option value="date_desc">Newest</option><option value="date_asc">Oldest</option><option value="bpm_desc">BPM ‚Üì</option><option value="bpm_asc">BPM ‚Üë</option><option value="len_desc">Longest</option><option value="len_asc">Shortest</option>';
    row.appendChild(sortSel); els.sort=sortSel;

    // Search
    var btnSearch=document.createElement('button'); btnSearch.className='btn'; btnSearch.id='btnSearch'; btnSearch.title='Search'; btnSearch.textContent='üîç'; row.appendChild(btnSearch);
    var searchWrap=document.createElement('div'); searchWrap.className='search-wrap'; searchWrap.innerHTML='<input id="searchInput" placeholder="Search‚Ä¶ use #tags (e.g. #mbv)" inputmode="search" />';
    tb.appendChild(searchWrap);
    var searchInput=searchWrap.querySelector('#searchInput');

    btnSearch.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      searchWrap.style.display = (searchWrap.style.display==='none'||!searchWrap.style.display) ? 'block' : 'none';
      if (searchWrap.style.display==='block'){ searchInput.value=state.searchQuery; try{ searchInput.focus(); }catch(_){ } }
      keepMenuOpen(e);
    });
    searchInput.addEventListener('input', debounce(function(){
      state.searchQuery = searchInput.value || '';
      applyFilterSort(false,true);
    }, 150));

    // Utilities panel
    var util=document.createElement('div'); util.className='util-panel';
    util.innerHTML = '<div class="util-row">' +
      '<button class="tog" id="togTitles" title="Song Titles (on/off)">üìù</button>' +
      '<button class="tog" id="togWav" title="Show WAV buttons">üéöÔ∏è</button>' +
      '<button class="tog" id="togMov" title="Show MOV buttons">üé¨</button>' +
    '</div>';
    tb.appendChild(util);

    btnUtils.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      util.style.display = (util.style.display==='none' || !util.style.display) ? 'block' : 'none';
      keepMenuOpen(e);
    });

    // Links panel (YouTube ‚Ä¢ Bandcamp ‚Ä¢ Substack ‚Ä¢ Instagram)
    var links=document.createElement('div'); links.className='links-panel';
    links.innerHTML = '<div class="links-row">' +
      '<a class="btn" href="https://www.youtube.com/@VVVVIIPP25" target="_blank" rel="noopener" title="YouTube">üì∫</a>' +
      '<a class="btn" href="https://virtualvip.bandcamp.com/" target="_blank" rel="noopener" title="Bandcamp">üéß</a>' +
      '<a class="btn" href="https://substack.com/home/post/p-170664918?source=queue" target="_blank" rel="noopener" title="Newsletter">üì∞</a>' +
      '<a class="btn" href="https://www.instagram.com/virtualvip24/" target="_blank" rel="noopener" title="Instagram">üì∑</a>' +
    '</div>';
    tb.appendChild(links);

    btnLinks.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      links.style.display = (links.style.display==='none' || !links.style.display) ? 'block' : 'none';
      keepMenuOpen(e);
    });

    // Wire toggles
    var btnTitles=util.querySelector('#togTitles');
    var btnWav=util.querySelector('#togWav');
    var btnMov=util.querySelector('#togMov');

    function syncToggles(){
      btnTitles.classList.toggle('on', state.showTitles);
      btnWav.classList.toggle('on', state.showWavButtons);
      btnMov.classList.toggle('on', state.showMovButtons);
    }
    syncToggles();

    btnTitles.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); state.showTitles=!state.showTitles; syncToggles(); refreshTitles(); keepMenuOpen(e); });
    btnWav.addEventListener('click',    function(e){ e.preventDefault(); e.stopPropagation(); state.showWavButtons=!state.showWavButtons; syncToggles(); rerenderVisibleRowsBadges(); if(state.i>=0) updateNowbar(); keepMenuOpen(e); });
    btnMov.addEventListener('click',    function(e){ e.preventDefault(); e.stopPropagation(); state.showMovButtons=!state.showMovButtons; syncToggles(); rerenderVisibleRowsBadges(); if(state.i>=0) updateNowbar(); keepMenuOpen(e); });

    tb.addEventListener('click', keepMenuOpen);

    // Sort change
    sortSel.addEventListener('change', function(e){ applyFilterSort(false,true); keepMenuOpen(e); });
  }

  function keepMenuOpen(e){ var menu=els.menu; if(!menu) return; if (e && e.preventDefault) e.preventDefault(); if (e && e.stopPropagation) e.stopPropagation(); menu.open=true; }

  // ---------- Player wiring ----------
  function wirePlayer(){
    var tgl = document.querySelector('#toggle');
    if (tgl) tgl.addEventListener('click', function(){ if (state.i<0 && state.filtered.length) select(0); if (state.playing) pause(); else play(); });

    if (els.prev) els.prev.addEventListener('click', function(){ jump(-1); });
    if (els.next) els.next.addEventListener('click', function(){ jump(1); });

    els.audio.addEventListener('timeupdate', function(){
      var a=els.audio; if(!isFinite(a.duration)) return;
      els.seek.max = Math.floor(a.duration);
      els.seek.value = Math.floor(a.currentTime);
      $('#tcur').textContent = fmtDur(a.currentTime);
      $('#tdur').textContent = isFinite(a.duration) ? fmtDur(a.duration) : '0:00';
    });
    els.seek.addEventListener('input', function(){ els.audio.currentTime = Number(els.seek.value); });
    els.vol.addEventListener('input', function(){ els.audio.volume = parseFloat(els.vol.value); try{ localStorage.setItem('vvip25:vol', els.vol.value); }catch(_){ } });
    els.audio.addEventListener('ended', function(){ jump(1); });

    // Row click + favourites
    document.addEventListener('click', function(e){
      var favBtn = e.target && e.target.closest ? e.target.closest('.star') : null;
      if (favBtn && favBtn.hasAttribute('data-fav')){
        var key = favBtn.getAttribute('data-fav');
        var wasFav = state.favorites.has(key);
        if (wasFav){ state.favorites.delete(key); state.favOrder = state.favOrder.filter(function(n){ return n!==key; }); }
        else { state.favorites.add(key); if (state.favOrder.indexOf(key)===-1) state.favOrder.push(key); }
        try{
          localStorage.setItem('vvip25:favs', JSON.stringify(Array.from(state.favorites)));
          localStorage.setItem('vvip25:favOrder', JSON.stringify(state.favOrder));
        }catch(_){}
        favBtn.classList.toggle('on', !wasFav);
        e.preventDefault(); e.stopPropagation();
        return;
      }
      var row = e.target && e.target.closest ? e.target.closest('.row') : null;
      if (row && !(e.target && e.target.closest && e.target.closest('a'))){
        var id = parseInt(row.getAttribute('data-id'),10);
        var idx=-1; for (var i=0;i<state.filtered.length;i++){ if (state.filtered[i].id===id){ idx=i; break; } }
        if (idx>=0){ select(idx); play(); }
      }
    }, false);
  }

  // ---------- Start after DOM ready ----------
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
</script>
</body>
</html>